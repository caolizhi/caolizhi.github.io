<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>JVM系列 —— 类的生命周期之类加载 - 操先森的博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="操先森的博客"><meta name="msapplication-TileImage" content="/images/logo.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="操先森的博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="这是 JVM 系列的第三篇，见 JVM 系列。 写在前面在提到 JVM 类加载的时候，经常容易把类加载机制和类加载器搞混淆，虽然两者紧密联系，但是实际上应该从不同的角度去理解，类加载机制可以看做是一个流程，类似软件产品从需求（class 文件格式）到落地（class 对象）的过程，而类加载器在类加载机制的流程中充当执行者，类似于软件产品中输出的IT人员。所这里想分开讨论一下。 首先来看类加载机制类"><meta property="og:type" content="blog"><meta property="og:title" content="JVM系列 —— 类的生命周期之类加载"><meta property="og:url" content="https://caolizhi.top/2021-12-JVM%E7%B3%BB%E5%88%97-%E7%B1%BB%E5%8A%A0%E8%BD%BD/"><meta property="og:site_name" content="操先森的博客"><meta property="og:description" content="这是 JVM 系列的第三篇，见 JVM 系列。 写在前面在提到 JVM 类加载的时候，经常容易把类加载机制和类加载器搞混淆，虽然两者紧密联系，但是实际上应该从不同的角度去理解，类加载机制可以看做是一个流程，类似软件产品从需求（class 文件格式）到落地（class 对象）的过程，而类加载器在类加载机制的流程中充当执行者，类似于软件产品中输出的IT人员。所这里想分开讨论一下。 首先来看类加载机制类"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://caolizhi.top/images/og_image.png"><meta property="article:published_time" content="2021-12-01T01:21:27.000Z"><meta property="article:modified_time" content="2021-12-01T01:21:27.000Z"><meta property="article:author" content="操先森"><meta property="article:tag" content="JVM"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://caolizhi.top/2021-12-JVM%E7%B3%BB%E5%88%97-%E7%B1%BB%E5%8A%A0%E8%BD%BD/"},"headline":"JVM系列 —— 类的生命周期之类加载","image":["https://caolizhi.top/images/og_image.png"],"datePublished":"2021-12-01T01:21:27.000Z","dateModified":"2021-12-01T01:21:27.000Z","author":{"@type":"Person","name":"操先森"},"publisher":{"@type":"Organization","name":"操先森的博客","logo":{"@type":"ImageObject","url":"https://caolizhi.top/images/logo.svg"}},"description":"这是 JVM 系列的第三篇，见 JVM 系列。 写在前面在提到 JVM 类加载的时候，经常容易把类加载机制和类加载器搞混淆，虽然两者紧密联系，但是实际上应该从不同的角度去理解，类加载机制可以看做是一个流程，类似软件产品从需求（class 文件格式）到落地（class 对象）的过程，而类加载器在类加载机制的流程中充当执行者，类似于软件产品中输出的IT人员。所这里想分开讨论一下。 首先来看类加载机制类"}</script><link rel="canonical" href="https://caolizhi.top/2021-12-JVM%E7%B3%BB%E5%88%97-%E7%B1%BB%E5%8A%A0%E8%BD%BD/"><link rel="icon" href="/images/logo.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?c2c31a128dbe61bc1214fcf1f334afd1";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-210020245-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-210020245-1');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/logo.svg" alt="操先森的博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/caolizhi"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-12-01T01:21:27.000Z" title="2021/12/1 上午9:21:27">2021-12-01</time>发表</span><span class="level-item"><time dateTime="2021-12-01T01:21:27.000Z" title="2021/12/1 上午9:21:27">2021-12-01</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Java/">Java</a><span> / </span><a class="link-muted" href="/categories/Java/JVM/">JVM</a></span><span class="level-item">36 分钟读完 (大约5345个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">JVM系列 —— 类的生命周期之类加载</h1><div class="content"><p>这是 JVM 系列的第三篇，<a href="https://caolizhi.top/categories/Java/JVM/">见 JVM 系列</a>。</p>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>在提到 JVM 类加载的时候，经常容易把类加载机制和类加载器搞混淆，虽然两者紧密联系，但是实际上应该从不同的角度去理解，类加载机制可以看做是一个流程，类似软件产品从需求（class 文件格式）到落地（class 对象）的过程，而类加载器在类加载机制的流程中充当执行者，类似于软件产品中输出的IT人员。所这里想分开讨论一下。</p>
<h3 id="首先来看类加载机制"><a href="#首先来看类加载机制" class="headerlink" title="首先来看类加载机制"></a>首先来看类加载机制</h3><p>类的生命周期说法大致相同，从大的角度来说，包括：<strong>加载 –&gt; 链接 -&gt; 初始化 -&gt; 使用 -&gt; 卸载</strong>；<br>从小的细节来说，包括：<strong>加载 –&gt; 验证 –&gt; 准备 –&gt; 解析 -&gt; 初始化 -&gt; 使用 -&gt; 卸载</strong>；<br>画个图如下：</p>
<p><img src="/2021-12-JVM%E7%B3%BB%E5%88%97-%E7%B1%BB%E5%8A%A0%E8%BD%BD/class_lifecycle.png" alt="类的生命周期"></p>
<ul>
<li><p><strong>加载</strong>：就是通过类的二进制表示来创建类或接口的过程，大白话就是，找到 class 文件，放到内存里面（<strong>在 metaspace 区域</strong>），构建java类的原型–类模板对象，相当于一个快照，jvm 随便用，给机器看的。</p>
</li>
<li><p><strong>链接</strong>：将类或接口并入虚拟机运行时状态的过程。链接的主要作用就是将字节码指令中的常量池的符号引用解析为指针、偏移量等内存地址的直接引用。</p>
<blockquote>
<p>这里有点晕，需要看一下计算机操作系统的链接部分内容。</p>
</blockquote>
</li>
<li><p><strong>初始化</strong>：类或接口的初始化是执行类或接口的初始化方法 <code>&lt;clinit&gt;</code>，如果类中有 <code>static</code>字段或<code>static&#123;&#125;</code>代码块，会产生一个 <code>&lt;clinit&gt;</code>的方法。</p>
<blockquote>
<p>与实例的初始化方法 <code>&lt;init&gt;</code> 不同，实例的初始化是调用构造器，发生在类或接口已经初始化之后，而 <code>&lt;clinit&gt;</code> 发生在类加载到虚拟机的初始化阶段。</p>
</blockquote>
</li>
</ul>
<span id="more"></span>

<h3 id="其次来看类加载器"><a href="#其次来看类加载器" class="headerlink" title="其次来看类加载器"></a>其次来看类加载器</h3><p>JVM 规范支持两种类加载器：</p>
<ul>
<li>java 虚拟机提供的引导类加载器（bootstrap class loader）</li>
<li>用户自定义的类加载器</li>
</ul>
<p>而针对 JVM 实现上，java 体系中有三种类加载器，JDK 8 实现的类加载的三级层次结构：</p>
<ul>
<li>Boostrap class loader<br>主要加载 <code>rt.jar</code> 和 其他在 <code>$JAVA_HOME/jre/lib</code> 路径下面的核心类库，还有通过参数 <code>-Xbootclasspath</code> 指定的目录。</li>
<li>Extension class loader<br>主要加载 <code>$JAVA_HOME/jre/lib/ext</code> 下面的类还有系统属性 <code>java.ext.dirs</code> 指定目录的类库。</li>
<li>System class loader<br>也成为 Application class loader，主要加载应用程序的类库，即有系统环境变量 <code>ClassPath</code>、<code>-cp</code> 命令或者系统属性 <code>java.class.path</code> 指定的类库。<blockquote>
<p>JDK 9 起，jdk 的类库管理发生了很大的变化，引入了平台模块系统（参考 <a target="_blank" rel="noopener" href="http://openjdk.java.net/projects/jigsaw/spec/">Java Platform Module System (JSR 376)</a>），把各个类库拆分组合成一个一个的模块，此时，针对类加载器的变化就是， <code>Extension Classloader</code> 改名成 <code>Platform class loader</code>，并且和 <code>Bootstrap class loader</code> 分别加载不同的模块，具体的模块参考下面的 JEP 文档。<br>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/ClassLoader.html">jdk11 API 文档</a></li>
<li><a target="_blank" rel="noopener" href="http://openjdk.java.net/jeps/261">JDK 改进提案: JEP 261</a></li>
</ul>
</blockquote>
</li>
</ul>
<p>当然，除了上述的三个层级的类加载器，也可以自定义类加载器。下面的示例展示了 jdk8 和 jdk11 的不同类加载器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderLevel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JDK 8 ：</span></span><br><span class="line"><span class="comment">         String 类的 ClassLoader 是：null</span></span><br><span class="line"><span class="comment">         --------------</span></span><br><span class="line"><span class="comment">         示例类的 ClassLoader 是：sun.misc.Launcher$AppClassLoader@18b4aac2</span></span><br><span class="line"><span class="comment">         示例类的 ClassLoader 的父加载器是：sun.misc.Launcher$ExtClassLoader@2f0e140b</span></span><br><span class="line"><span class="comment">         示例类的 ClassLoader 的 ClassLoader 是：null</span></span><br><span class="line"><span class="comment">         --------------</span></span><br><span class="line"><span class="comment">         系统 ClassLoader 是：sun.misc.Launcher$AppClassLoader@18b4aac2</span></span><br><span class="line"><span class="comment">         系统 ClassLoader 的父加载器是：sun.misc.Launcher$ExtClassLoader@2f0e140b</span></span><br><span class="line"><span class="comment">         系统 ClassLoader 的 ClassLoader 是：null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JDK 11 打印：</span></span><br><span class="line"><span class="comment">         String 类的 ClassLoader 是：null</span></span><br><span class="line"><span class="comment">         --------------</span></span><br><span class="line"><span class="comment">         示例类的 ClassLoader 是：jdk.internal.loader.ClassLoaders$AppClassLoader@1f89ab83</span></span><br><span class="line"><span class="comment">         示例类的 ClassLoader 的父加载器是：jdk.internal.loader.ClassLoaders$PlatformClassLoader@6108b2d7</span></span><br><span class="line"><span class="comment">         示例类的 ClassLoader 的 ClassLoader 是：null</span></span><br><span class="line"><span class="comment">         --------------</span></span><br><span class="line"><span class="comment">         系统 ClassLoader 是：jdk.internal.loader.ClassLoaders$AppClassLoader@1f89ab83</span></span><br><span class="line"><span class="comment">         系统 ClassLoader 的父加载器是：jdk.internal.loader.ClassLoaders$PlatformClassLoader@6108b2d7</span></span><br><span class="line"><span class="comment">         系统 ClassLoader 的 ClassLoader 是：null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;String 类的 ClassLoader 是：&quot;</span> + String.class.getClassLoader());</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;示例类的 ClassLoader 是：&quot;</span> + ClassLoaderLevel.class.getClassLoader());</span><br><span class="line">        System.out.println(<span class="string">&quot;示例类的 ClassLoader 的父加载器是：&quot;</span> + ClassLoaderLevel.class.getClassLoader().getParent());</span><br><span class="line">        System.out.println(<span class="string">&quot;示例类的 ClassLoader 的 ClassLoader 是：&quot;</span> + ClassLoaderLevel.class.getClassLoader().getClass().getClassLoader());</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;系统 ClassLoader 是：&quot;</span> + ClassLoader.getSystemClassLoader());</span><br><span class="line">        System.out.println(<span class="string">&quot;系统 ClassLoader 的父加载器是：&quot;</span> + ClassLoader.getSystemClassLoader().getParent());</span><br><span class="line">        System.out.println(<span class="string">&quot;系统 ClassLoader 的 ClassLoader 是：&quot;</span> + ClassLoader.getSystemClassLoader().getClass().getClassLoader());</span><br><span class="line"></span><br><span class="line">        System.out.println(System.getProperty(<span class="string">&quot;sun.boot.class.path&quot;</span>)); <span class="comment">//jdk8 打印 rt.jar 的类，jdk11 空</span></span><br><span class="line">        System.out.println(System.getProperty(<span class="string">&quot;java.ext.dirs&quot;</span>)); <span class="comment">// jdk8 打印 ext 类， jdk11 空</span></span><br><span class="line">        System.out.println(System.getProperty(<span class="string">&quot;java.class.path&quot;</span>)); <span class="comment">// jdk8 和 jdk 11 都打印 classpath 下的 jar</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="虚拟机启动"><a href="#虚拟机启动" class="headerlink" title="虚拟机启动"></a>虚拟机启动</h2><p>JVM 虚拟机规范在第五章说明了虚拟机启动时的步骤，大概流程可以用如下图所示：<br><img src="/2021-12-JVM%E7%B3%BB%E5%88%97-%E7%B1%BB%E5%8A%A0%E8%BD%BD/jvm_startup.png" alt="虚拟机启动示意图"></p>
<h2 id="oop-klass-模型"><a href="#oop-klass-模型" class="headerlink" title="oop-klass 模型"></a>oop-klass 模型</h2><p>在说到类加载的时候，为了更好的弄清楚类加载的过程和原理，必然要提到 oop-klass 模型，简单的说，每一个 java class 加载到 JVM 中，JVM会产生一个与之对应的类模板对象，实际上是一个 C++ 的实例。这个类模板对象，从两个维度来说，一个是 oop（Ordinary Object Pointer） 模型，一个是 klass 模型，klass 存放的是这个类的元数据，类的信息，而 oop 则保存了实例的数据。举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A a = <span class="keyword">new</span> A();</span><br><span class="line">A b = <span class="keyword">new</span> A();</span><br></pre></td></tr></table></figure>
<p>上面的代码最终反映到 JVM 层面，a 和 b 的 JVM klass 都是相同的，但是 oop 不同。看一下 <a target="_blank" rel="noopener" href="https://github.com/adoptium/jdk8u">jdk8 源码</a> 的 oop 体系和 klass 体系：</p>
<ul>
<li><h3 id="oop"><a href="#oop" class="headerlink" title="oop"></a>oop</h3><p>Hotspot 里面的 oop 其实就是 GC 托管的指针，每一个 oop 都是一种 xxxOopDesc* 类型的指针。在 Hotspot 里面 oop 就指一个 真的指针。</p>
<p><img src="/2021-12-JVM%E7%B3%BB%E5%88%97-%E7%B1%BB%E5%8A%A0%E8%BD%BD/oop.png" alt="oop"></p>
<p>看 JVM 源码 <code>hotspot/src/share/vm/oops/oop.hpp</code> ，<code>&#123;name&#125;Desc</code> 描述了 java 对象的结构， 能够从 C++ 访问得到。<br><img src="/2021-12-JVM%E7%B3%BB%E5%88%97-%E7%B1%BB%E5%8A%A0%E8%BD%BD/oop_source.png" alt="oop 源码"></p>
<p><code>hotspot/src/share/vm/oops/oopsHierarchy.hpp</code>  定义了 oop 的层级和含义：<br><img src="/2021-12-JVM%E7%B3%BB%E5%88%97-%E7%B1%BB%E5%8A%A0%E8%BD%BD/oop_hierachy.png" alt="oop 层级类"></p>
<p>在 JVM 中， <code>instanceOop</code> 表示一个 java 的一个实例对象，这个实例对象是可以从 C++ 层面能访问到的。<code>markOop</code> 是一个比较特殊的类型，看起来是一个像指针，实际上是藏在指针里面的对象（数据）。不收 GC 托管。只是为了满足“面向对象”编程而设计的。路径 <code>share/vm/oops/markOop.hpp</code><br><img src="/2021-12-JVM%E7%B3%BB%E5%88%97-%E7%B1%BB%E5%8A%A0%E8%BD%BD/oop_markOop.png" alt="markOop"></p>
<p>oop 一般有对象头、对象专有属性和数据体这 3 部分组成。</p>
</li>
<li><h3 id="klass"><a href="#klass" class="headerlink" title="klass"></a>klass</h3><p>按照 官方文档，klass 提供两种能力：</p>
<ul>
<li>提供一个与 java 类对等的 C++ 类型描述</li>
<li>提供虚拟机内部的函数分发机制（没有搞过 C++，不是很理解）<br>JVM 里面 klass 的层级结构如下：<img src="/2021-12-JVM%E7%B3%BB%E5%88%97-%E7%B1%BB%E5%8A%A0%E8%BD%BD/klass.png" alt="klass"></li>
</ul>
</li>
</ul>
<p>总之一句话，<strong>每一个 java class 字节流文件，最终都会 JVM 内部产生一个 klassOop 和它对等，java类的字段、方法以及常量池都会保存到 klassOop 实例对象中。</strong></p>
<h2 id="类加载"><a href="#类加载" class="headerlink" title="类加载"></a>类加载</h2><p>虚拟机运行的时候，一个类或接口不仅仅是有二进制名称来确定的，还有它的定义类加载共同确定的，也就是说，类名称相同，但是是不同类加载加载的，那么最后生成实例是两个不同类型的实例。</p>
<p>在上一篇讲过 class 文件格式，那么 JVM 是怎样去解析这个 class 文件呢？</p>
<blockquote>
<p>这里要说明的是，这个 class 文件格式并不仅仅局限于二进制文件，也有可能从网络加载，但是最终解析的都是 class 文件的二进制字节流</p>
</blockquote>
<p>对于类的解析逻辑在源码 <code>hotspot/src/share/vm/classfile/classFileParser.cpp</code> 的 <code>ClassFileParser::parseClassFile()</code> 函数中，贴一下源码：  </p>
<details>
<summary>类文件解析源码</summary>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">instanceKlassHandle <span class="title">ClassFileParser::parseClassFile</span><span class="params">(Symbol* name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    ClassLoaderData* loader_data,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    Handle protection_domain,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    KlassHandle host_klass,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    GrowableArray&lt;Handle&gt;* cp_patches,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    TempNewSymbol&amp; parsed_name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    <span class="keyword">bool</span> verify,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    TRAPS)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// class 流</span></span><br><span class="line">  ClassFileStream* cfs = <span class="built_in">stream</span>();</span><br><span class="line">  </span><br><span class="line">   ... ...</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 魔数值校验</span></span><br><span class="line">  u4 magic = cfs-&gt;<span class="built_in">get_u4_fast</span>();</span><br><span class="line">  <span class="built_in">guarantee_property</span>(magic == JAVA_CLASSFILE_MAGIC,</span><br><span class="line">                     <span class="string">&quot;Incompatible magic value %u in class file %s&quot;</span>,</span><br><span class="line">                     magic, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 版本号校验</span></span><br><span class="line">  u2 minor_version = cfs-&gt;<span class="built_in">get_u2_fast</span>();</span><br><span class="line">  u2 major_version = cfs-&gt;<span class="built_in">get_u2_fast</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (DumpSharedSpaces &amp;&amp; major_version &lt; JAVA_1_5_VERSION) &#123;</span><br><span class="line">    ... ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check version numbers - we check this even with verifier off</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">is_supported_version</span>(major_version, minor_version)) &#123;</span><br><span class="line">    ... ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _major_version = major_version;</span><br><span class="line">  _minor_version = minor_version;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解析常量池</span></span><br><span class="line">  constantPoolHandle cp = <span class="built_in">parse_constant_pool</span>(<span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 访问标志</span></span><br><span class="line">  AccessFlags access_flags;</span><br><span class="line">   </span><br><span class="line">   ... ... </span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((flags &amp; JVM_ACC_INTERFACE) &amp;&amp; _major_version &lt; JAVA_6_VERSION) &#123;</span><br><span class="line">   ... ...</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="comment">// 类索引</span></span><br><span class="line">  _this_class_index = cfs-&gt;<span class="built_in">get_u2_fast</span>();</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 父类索引</span></span><br><span class="line">    instanceKlassHandle super_klass = <span class="built_in">parse_super_class</span>(super_class_index,</span><br><span class="line">                                                        CHECK_NULL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接口</span></span><br><span class="line">    u2 itfs_len = cfs-&gt;<span class="built_in">get_u2_fast</span>();</span><br><span class="line">    Array&lt;Klass*&gt;* local_interfaces =</span><br><span class="line">      <span class="built_in">parse_interfaces</span>(itfs_len, protection_domain, _class_name,</span><br><span class="line">                       &amp;has_default_methods, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    u2 java_fields_count = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 字段解析</span></span><br><span class="line">    Array&lt;u2&gt;* fields = <span class="built_in">parse_fields</span>(class_name,</span><br><span class="line">                                     access_flags.<span class="built_in">is_interface</span>(),</span><br><span class="line">                                     &amp;fac, &amp;java_fields_count,</span><br><span class="line">                                     <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line">    <span class="comment">// 方法解析</span></span><br><span class="line">    Array&lt;Method*&gt;* methods = <span class="built_in">parse_methods</span>(access_flags.<span class="built_in">is_interface</span>(),</span><br><span class="line">                                            &amp;promoted_flags,</span><br><span class="line">                                            &amp;has_final_method,</span><br><span class="line">                                            &amp;declares_default_methods,</span><br><span class="line">                                            <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 属性解析</span></span><br><span class="line">    ClassAnnotationCollector parsed_annotations;</span><br><span class="line">    <span class="built_in">parse_classfile_attributes</span>(&amp;parsed_annotations, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建与 java 类对等的内部对象</span></span><br><span class="line">    _klass = InstanceKlass::<span class="built_in">allocate_instance_klass</span>(loader_data,</span><br><span class="line">                                                    vtable_size,</span><br><span class="line">                                                    itable_size,</span><br><span class="line">                                                    info.static_field_size,</span><br><span class="line">                                                    total_oop_map_size2,</span><br><span class="line">                                                    rt,</span><br><span class="line">                                                    access_flags,</span><br><span class="line">                                                    name,</span><br><span class="line">                                                    <span class="built_in">super_klass</span>(),</span><br><span class="line">                                                    !host_klass.<span class="built_in">is_null</span>(),</span><br><span class="line">                                                    <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line">    <span class="function">instanceKlassHandle <span class="title">this_klass</span> <span class="params">(THREAD, _klass)</span></span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Fill in information already parsed</span></span><br><span class="line">    this_klass-&gt;<span class="built_in">set_should_verify_class</span>(verify);</span><br><span class="line">    jint lh = Klass::<span class="built_in">instance_layout_helper</span>(info.instance_size, <span class="literal">false</span>);</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_layout_helper</span>(lh);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (has_final_method) &#123;</span><br><span class="line">      this_klass-&gt;<span class="built_in">set_has_final_method</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    this_klass-&gt;<span class="built_in">copy_method_ordering</span>(method_ordering, CHECK_NULL);</span><br><span class="line">    <span class="comment">// The InstanceKlass::_methods_jmethod_ids cache</span></span><br><span class="line">    <span class="comment">// is managed on the assumption that the initial cache</span></span><br><span class="line">    <span class="comment">// size is equal to the number of methods in the class. If</span></span><br><span class="line">    <span class="comment">// that changes, then InstanceKlass::idnum_can_increment()</span></span><br><span class="line">    <span class="comment">// has to be changed accordingly.</span></span><br><span class="line">    this_klass-&gt;<span class="built_in">set_initial_method_idnum</span>(methods-&gt;<span class="built_in">length</span>());</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_name</span>(cp-&gt;<span class="built_in">klass_name_at</span>(_this_class_index));</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">is_anonymous</span>())  <span class="comment">// I am well known to myself</span></span><br><span class="line">      cp-&gt;<span class="built_in">klass_at_put</span>(_this_class_index, <span class="built_in">this_klass</span>()); <span class="comment">// eagerly resolve</span></span><br><span class="line"></span><br><span class="line">    this_klass-&gt;<span class="built_in">set_minor_version</span>(minor_version);</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_major_version</span>(major_version);</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_has_default_methods</span>(has_default_methods);</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_declares_default_methods</span>(declares_default_methods);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!host_klass.<span class="built_in">is_null</span>()) &#123;</span><br><span class="line">      <span class="built_in">assert</span> (this_klass-&gt;<span class="built_in">is_anonymous</span>(), <span class="string">&quot;should be the same&quot;</span>);</span><br><span class="line">      this_klass-&gt;<span class="built_in">set_host_klass</span>(<span class="built_in">host_klass</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cached_class_file != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="comment">// JVMTI: we have an InstanceKlass now, tell it about the cached bytes</span></span><br><span class="line">      this_klass-&gt;<span class="built_in">set_cached_class_file</span>(cached_class_file);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建镜像类和静态字段初始化</span></span><br><span class="line">    java_lang_Class::<span class="built_in">create_mirror</span>(this_klass, class_loader, protection_domain,</span><br><span class="line">                                   <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>  

<br/>

<p>从源码里面可以看到，调用klass 的子类 <code>InstanceClass</code> 调用方法 <code>allocate_instance_klass()</code> 构建了一个 instanceKlass 对象实例。<code>InstanceKlass</code> 是虚拟机级别的java类的对等对象，包含了在运行期间构建一个类所有必要的信息。至此，java 类的生命周期的第一个阶段 —— <strong>加载</strong> 就结束了。下面的源码是 <code>InstanceKlass</code> 的结构：</p>
<details>
<summary> hotspot/src/share/vm/oops/instanceKlass.cpp </summary>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InstanceKlass</span>:</span> <span class="keyword">public</span> Klass &#123;</span><br><span class="line">  <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">VMStructs</span>;</span></span><br><span class="line">  <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassFileParser</span>;</span></span><br><span class="line">  <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">CompileReplay</span>;</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="comment">// Constructor</span></span><br><span class="line">  <span class="built_in">InstanceKlass</span>(<span class="keyword">int</span> vtable_len,</span><br><span class="line">                <span class="keyword">int</span> itable_len,</span><br><span class="line">                <span class="keyword">int</span> static_field_size,</span><br><span class="line">                <span class="keyword">int</span> nonstatic_oop_map_size,</span><br><span class="line">                ReferenceType rt,</span><br><span class="line">                AccessFlags access_flags,</span><br><span class="line">                <span class="keyword">bool</span> is_anonymous);</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">static</span> InstanceKlass* <span class="title">allocate_instance_klass</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                                          ClassLoaderData* loader_data,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">int</span> vtable_len,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">int</span> itable_len,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">int</span> static_field_size,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">int</span> nonstatic_oop_map_size,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          ReferenceType rt,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          AccessFlags access_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          Symbol* name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          Klass* super_klass,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">bool</span> is_anonymous,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          TRAPS)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">InstanceKlass</span>() &#123; <span class="built_in">assert</span>(DumpSharedSpaces || UseSharedSpaces, <span class="string">&quot;only for CDS&quot;</span>); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// See &quot;The Java Virtual Machine Specification&quot; section 2.16.2-5 for a detailed description</span></span><br><span class="line">  <span class="comment">// of the class loading &amp; initialization procedure, and the use of the states.</span></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">ClassState</span> &#123;</span></span><br><span class="line">    allocated,                          <span class="comment">// allocated (but not yet linked)</span></span><br><span class="line">    loaded,                             <span class="comment">// loaded and inserted in class hierarchy (but not linked yet)</span></span><br><span class="line">    linked,                             <span class="comment">// successfully linked/verified (but not initialized yet)</span></span><br><span class="line">    being_initialized,                  <span class="comment">// currently running class initializer</span></span><br><span class="line">    fully_initialized,                  <span class="comment">// initialized (successfull final state)</span></span><br><span class="line">    initialization_error                <span class="comment">// error happened during initialization</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">number_of_instance_classes</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _total_instanceKlass_count; &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> _total_instanceKlass_count;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="comment">// Annotations for this class</span></span><br><span class="line">  Annotations*    _annotations;</span><br><span class="line">  <span class="comment">// Array classes holding elements of this class.</span></span><br><span class="line">  Klass*          _array_klasses;</span><br><span class="line">  <span class="comment">// Constant pool for this class.</span></span><br><span class="line">  ConstantPool* _constants;</span><br><span class="line">  <span class="comment">// The InnerClasses attribute and EnclosingMethod attribute. The</span></span><br><span class="line">  <span class="comment">// _inner_classes is an array of shorts. If the class has InnerClasses</span></span><br><span class="line">  <span class="comment">// attribute, then the _inner_classes array begins with 4-tuples of shorts</span></span><br><span class="line">  <span class="comment">// [inner_class_info_index, outer_class_info_index,</span></span><br><span class="line">  <span class="comment">// inner_name_index, inner_class_access_flags] for the InnerClasses</span></span><br><span class="line">  <span class="comment">// attribute. If the EnclosingMethod attribute exists, it occupies the</span></span><br><span class="line">  <span class="comment">// last two shorts [class_index, method_index] of the array. If only</span></span><br><span class="line">  <span class="comment">// the InnerClasses attribute exists, the _inner_classes array length is</span></span><br><span class="line">  <span class="comment">// number_of_inner_classes * 4. If the class has both InnerClasses</span></span><br><span class="line">  <span class="comment">// and EnclosingMethod attributes the _inner_classes array length is</span></span><br><span class="line">  <span class="comment">// number_of_inner_classes * 4 + enclosing_method_attribute_size.</span></span><br><span class="line">  Array&lt;jushort&gt;* _inner_classes;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the source debug extension for this klass, NULL if not specified.</span></span><br><span class="line">  <span class="comment">// Specified as UTF-8 string without terminating zero byte in the classfile,</span></span><br><span class="line">  <span class="comment">// it is stored in the instanceklass as a NULL-terminated UTF-8 string</span></span><br><span class="line">  <span class="keyword">char</span>*           _source_debug_extension;</span><br><span class="line">  <span class="comment">// Array name derived from this class which needs unreferencing</span></span><br><span class="line">  <span class="comment">// if this class is unloaded.</span></span><br><span class="line">  Symbol*         _array_name;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Number of heapOopSize words used by non-static fields in this klass</span></span><br><span class="line">  <span class="comment">// (including inherited fields but after header_size()).</span></span><br><span class="line">  <span class="keyword">int</span>             _nonstatic_field_size;</span><br><span class="line">  <span class="keyword">int</span>             _static_field_size;    <span class="comment">// number words used by static fields (oop and non-oop) in this klass</span></span><br><span class="line">  <span class="comment">// Constant pool index to the utf8 entry of the Generic signature,</span></span><br><span class="line">  <span class="comment">// or 0 if none.</span></span><br><span class="line">  u2              _generic_signature_index;</span><br><span class="line">  <span class="comment">// Constant pool index to the utf8 entry for the name of source file</span></span><br><span class="line">  <span class="comment">// containing this klass, 0 if not specified.</span></span><br><span class="line">  u2              _source_file_name_index;</span><br><span class="line">  u2              _static_oop_field_count;<span class="comment">// number of static oop fields in this klass</span></span><br><span class="line">  u2              _java_fields_count;    <span class="comment">// The number of declared Java fields</span></span><br><span class="line">  <span class="keyword">int</span>             _nonstatic_oop_map_size;<span class="comment">// size in words of nonstatic oop map blocks</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// _is_marked_dependent can be set concurrently, thus cannot be part of the</span></span><br><span class="line">  <span class="comment">// _misc_flags.</span></span><br><span class="line">  <span class="keyword">bool</span>            _is_marked_dependent;  <span class="comment">// used for marking during flushing and deoptimization</span></span><br><span class="line">  <span class="keyword">bool</span>            _is_being_redefined;   <span class="comment">// used for locking redefinition</span></span><br><span class="line">  <span class="keyword">bool</span>            _has_unloaded_dependent;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    _misc_rewritten                = <span class="number">1</span> &lt;&lt; <span class="number">0</span>, <span class="comment">// methods rewritten.</span></span><br><span class="line">    _misc_has_nonstatic_fields     = <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="comment">// for sizing with UseCompressedOops</span></span><br><span class="line">    _misc_should_verify_class      = <span class="number">1</span> &lt;&lt; <span class="number">2</span>, <span class="comment">// allow caching of preverification</span></span><br><span class="line">    _misc_is_anonymous             = <span class="number">1</span> &lt;&lt; <span class="number">3</span>, <span class="comment">// has embedded _host_klass field</span></span><br><span class="line">    _misc_is_contended             = <span class="number">1</span> &lt;&lt; <span class="number">4</span>, <span class="comment">// marked with contended annotation</span></span><br><span class="line">    _misc_has_default_methods      = <span class="number">1</span> &lt;&lt; <span class="number">5</span>, <span class="comment">// class/superclass/implemented interfaces has default methods</span></span><br><span class="line">    _misc_declares_default_methods = <span class="number">1</span> &lt;&lt; <span class="number">6</span>, <span class="comment">// directly declares default methods (any access)</span></span><br><span class="line">    _misc_has_been_redefined       = <span class="number">1</span> &lt;&lt; <span class="number">7</span>  <span class="comment">// class has been redefined</span></span><br><span class="line">  &#125;;</span><br><span class="line">  u2              _misc_flags;</span><br><span class="line">  u2              _minor_version;        <span class="comment">// minor version number of class file</span></span><br><span class="line">  u2              _major_version;        <span class="comment">// major version number of class file</span></span><br><span class="line">  Thread*         _init_thread;          <span class="comment">// Pointer to current thread doing initialization (to handle recursive initialization)</span></span><br><span class="line">  <span class="keyword">int</span>             _vtable_len;           <span class="comment">// length of Java vtable (in words)</span></span><br><span class="line">  <span class="keyword">int</span>             _itable_len;           <span class="comment">// length of Java itable (in words)</span></span><br><span class="line">  OopMapCache*    <span class="keyword">volatile</span> _oop_map_cache;   <span class="comment">// OopMapCache for all methods in the klass (allocated lazily)</span></span><br><span class="line">  MemberNameTable* _member_names;        <span class="comment">// Member names</span></span><br><span class="line">  JNIid*          _jni_ids;              <span class="comment">// First JNI identifier for static fields in this class</span></span><br><span class="line">  jmethodID*      _methods_jmethod_ids;  <span class="comment">// jmethodIDs corresponding to method_idnum, or NULL if none</span></span><br><span class="line">  nmethodBucket*  _dependencies;         <span class="comment">// list of dependent nmethods</span></span><br><span class="line">  nmethod*        _osr_nmethods_head;    <span class="comment">// Head of list of on-stack replacement nmethods for this class</span></span><br><span class="line">  BreakpointInfo* _breakpoints;          <span class="comment">// bpt lists, managed by Method*</span></span><br><span class="line">  <span class="comment">// Linked instanceKlasses of previous versions</span></span><br><span class="line">  InstanceKlass* _previous_versions;</span><br><span class="line">  <span class="comment">// JVMTI fields can be moved to their own structure - see 6315920</span></span><br><span class="line">  <span class="comment">// JVMTI: cached class file, before retransformable agent modified it in CFLH</span></span><br><span class="line">  JvmtiCachedClassFileData* _cached_class_file;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">volatile</span> u2     _idnum_allocated_count;         <span class="comment">// JNI/JVMTI: increments with the addition of methods, old ids don&#x27;t change</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Class states are defined as ClassState (see above).</span></span><br><span class="line">  <span class="comment">// Place the _init_state here to utilize the unused 2-byte after</span></span><br><span class="line">  <span class="comment">// _idnum_allocated_count.</span></span><br><span class="line">  u1              _init_state;                    <span class="comment">// state of class</span></span><br><span class="line">  u1              _reference_type;                <span class="comment">// reference type</span></span><br><span class="line"></span><br><span class="line">  JvmtiCachedClassFieldMap* _jvmti_cached_class_field_map;  <span class="comment">// JVMTI: used during heap iteration</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">NOT_PRODUCT</span>(<span class="keyword">int</span> _verify_count;)  <span class="comment">// to avoid redundant verifies</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Method array.</span></span><br><span class="line">  Array&lt;Method*&gt;* _methods;</span><br><span class="line">  <span class="comment">// Default Method Array, concrete methods inherited from interfaces</span></span><br><span class="line">  Array&lt;Method*&gt;* _default_methods;</span><br><span class="line">  <span class="comment">// Interface (Klass*s) this class declares locally to implement.</span></span><br><span class="line">  Array&lt;Klass*&gt;* _local_interfaces;</span><br><span class="line">  <span class="comment">// Interface (Klass*s) this class implements transitively.</span></span><br><span class="line">  Array&lt;Klass*&gt;* _transitive_interfaces;</span><br><span class="line">  <span class="comment">// Int array containing the original order of method in the class file (for JVMTI).</span></span><br><span class="line">  Array&lt;<span class="keyword">int</span>&gt;*     _method_ordering;</span><br><span class="line">  <span class="comment">// Int array containing the vtable_indices for default_methods</span></span><br><span class="line">  <span class="comment">// offset matches _default_methods offset</span></span><br><span class="line">  Array&lt;<span class="keyword">int</span>&gt;*     _default_vtable_indices;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Instance and static variable information, starts with 6-tuples of shorts</span></span><br><span class="line">  <span class="comment">// [access, name index, sig index, initval index, low_offset, high_offset]</span></span><br><span class="line">  <span class="comment">// for all fields, followed by the generic signature data at the end of</span></span><br><span class="line">  <span class="comment">// the array. Only fields with generic signature attributes have the generic</span></span><br><span class="line">  <span class="comment">// signature data set in the array. The fields array looks like following:</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// f1: [access, name index, sig index, initial value index, low_offset, high_offset]</span></span><br><span class="line">  <span class="comment">// f2: [access, name index, sig index, initial value index, low_offset, high_offset]</span></span><br><span class="line">  <span class="comment">//      ...</span></span><br><span class="line">  <span class="comment">// fn: [access, name index, sig index, initial value index, low_offset, high_offset]</span></span><br><span class="line">  <span class="comment">//     [generic signature index]</span></span><br><span class="line">  <span class="comment">//     [generic signature index]</span></span><br><span class="line">  <span class="comment">//     ...</span></span><br><span class="line">  Array&lt;u2&gt;*      _fields;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** 预留空间来存放 vtable(虚拟表), itable(接口表), 静态字段，引用的 map</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// embedded Java vtable follows here</span></span><br><span class="line">  <span class="comment">// embedded Java itables follows here</span></span><br><span class="line">  <span class="comment">// embedded static fields follows here</span></span><br><span class="line">  <span class="comment">// embedded nonstatic oop-map blocks follows here</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// embedded implementor of this interface follows here</span></span><br><span class="line">  <span class="comment">//   The embedded implementor only exists if the current klass is an</span></span><br><span class="line">  <span class="comment">//   iterface. The possible values of the implementor fall into following</span></span><br><span class="line">  <span class="comment">//   three cases:</span></span><br><span class="line">  <span class="comment">//     NULL: no implementor.</span></span><br><span class="line">  <span class="comment">//     A Klass* that&#x27;s not itself: one implementor.</span></span><br><span class="line">  <span class="comment">//     Itself: more than one implementors.</span></span><br><span class="line">  <span class="comment">// embedded host klass follows here</span></span><br><span class="line">  <span class="comment">//   The embedded host klass only exists in an anonymous class for</span></span><br><span class="line">  <span class="comment">//   dynamic language support (JSR 292 enabled). The host class grants</span></span><br><span class="line">  <span class="comment">//   its access privileges to this class also. The host class is either</span></span><br><span class="line">  <span class="comment">//   named, or a previously loaded anonymous class. A non-anonymous class</span></span><br><span class="line">  <span class="comment">//   or an anonymous class loaded through normal classloading does not</span></span><br><span class="line">  <span class="comment">//   have this embedded field.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>
<br/>
在上面解析 class 文件的源码中，我们看到了在调用 `allocate_instance_klass()` 创建一个 instanceKlass 之后，看到 `create_mirror()` 的函数，创建一个镜像类，接下来看看这个镜像类。

<h2 id="镜像类和静态字段"><a href="#镜像类和静态字段" class="headerlink" title="镜像类和静态字段"></a>镜像类和静态字段</h2><p>看一下源码，位于 <code>hotspot/src/share/vm/classfile/javaClasses.cpp</code>。</p>
<details>
<summary>java_lang_Class::create_mirror() 函数</summary>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">java_lang_Class::create_mirror</span><span class="params">(KlassHandle k, Handle class_loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    Handle protection_domain, TRAPS)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">assert</span>(k-&gt;<span class="built_in">java_mirror</span>() == <span class="literal">NULL</span>, <span class="string">&quot;should only assign mirror once&quot;</span>);</span><br><span class="line">  <span class="comment">// Use this moment of initialization to cache modifier_flags also,</span></span><br><span class="line">  <span class="comment">// to support Class.getModifiers().  Instance classes recalculate</span></span><br><span class="line">  <span class="comment">// the cached flags after the class file is parsed, but before the</span></span><br><span class="line">  <span class="comment">// class is put into the system dictionary.</span></span><br><span class="line">  <span class="keyword">int</span> computed_modifiers = k-&gt;<span class="built_in">compute_modifier_flags</span>(CHECK);</span><br><span class="line">  k-&gt;<span class="built_in">set_modifier_flags</span>(computed_modifiers);</span><br><span class="line">  <span class="comment">// Class_klass has to be loaded because it is used to allocate</span></span><br><span class="line">  <span class="comment">// the mirror.</span></span><br><span class="line">  <span class="keyword">if</span> (SystemDictionary::<span class="built_in">Class_klass_loaded</span>()) &#123;</span><br><span class="line">    <span class="comment">// Allocate mirror (java.lang.Class instance)</span></span><br><span class="line">    Handle mirror = InstanceMirrorKlass::<span class="built_in">cast</span>(SystemDictionary::<span class="built_in">Class_klass</span>())-&gt;<span class="built_in">allocate_instance</span>(k, CHECK);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup indirection from mirror-&gt;klass</span></span><br><span class="line">    <span class="keyword">if</span> (!k.<span class="built_in">is_null</span>()) &#123;</span><br><span class="line">      java_lang_Class::<span class="built_in">set_klass</span>(<span class="built_in">mirror</span>(), <span class="built_in">k</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    InstanceMirrorKlass* mk = InstanceMirrorKlass::<span class="built_in">cast</span>(mirror-&gt;<span class="built_in">klass</span>());</span><br><span class="line">    <span class="built_in">assert</span>(<span class="built_in">oop_size</span>(<span class="built_in">mirror</span>()) == mk-&gt;<span class="built_in">instance_size</span>(k), <span class="string">&quot;should have been set&quot;</span>);</span><br><span class="line"></span><br><span class="line">    java_lang_Class::<span class="built_in">set_static_oop_field_count</span>(<span class="built_in">mirror</span>(), mk-&gt;<span class="built_in">compute_static_oop_field_count</span>(<span class="built_in">mirror</span>()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// It might also have a component mirror.  This mirror must already exist.</span></span><br><span class="line">    <span class="keyword">if</span> (k-&gt;<span class="built_in">oop_is_array</span>()) &#123;</span><br><span class="line">      Handle comp_mirror;</span><br><span class="line">      <span class="keyword">if</span> (k-&gt;<span class="built_in">oop_is_typeArray</span>()) &#123;</span><br><span class="line">        BasicType type = TypeArrayKlass::<span class="built_in">cast</span>(<span class="built_in">k</span>())-&gt;<span class="built_in">element_type</span>();</span><br><span class="line">        comp_mirror = Universe::<span class="built_in">java_mirror</span>(type);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">assert</span>(k-&gt;<span class="built_in">oop_is_objArray</span>(), <span class="string">&quot;Must be&quot;</span>);</span><br><span class="line">        Klass* element_klass = ObjArrayKlass::<span class="built_in">cast</span>(<span class="built_in">k</span>())-&gt;<span class="built_in">element_klass</span>();</span><br><span class="line">        <span class="built_in">assert</span>(element_klass != <span class="literal">NULL</span>, <span class="string">&quot;Must have an element klass&quot;</span>);</span><br><span class="line">        comp_mirror = element_klass-&gt;<span class="built_in">java_mirror</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">assert</span>(comp_mirror.<span class="built_in">not_null</span>(), <span class="string">&quot;must have a mirror&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Two-way link between the array klass and its component mirror:</span></span><br><span class="line">      ArrayKlass::<span class="built_in">cast</span>(<span class="built_in">k</span>())-&gt;<span class="built_in">set_component_mirror</span>(<span class="built_in">comp_mirror</span>());</span><br><span class="line">      <span class="built_in">set_array_klass</span>(<span class="built_in">comp_mirror</span>(), <span class="built_in">k</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">assert</span>(k-&gt;<span class="built_in">oop_is_instance</span>(), <span class="string">&quot;Must be&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">initialize_mirror_fields</span>(k, mirror, protection_domain, THREAD);</span><br><span class="line">      <span class="keyword">if</span> (HAS_PENDING_EXCEPTION) &#123;</span><br><span class="line">        <span class="comment">// If any of the fields throws an exception like OOM remove the klass field</span></span><br><span class="line">        <span class="comment">// from the mirror so GC doesn&#x27;t follow it after the klass has been deallocated.</span></span><br><span class="line">        <span class="comment">// This mirror looks like a primitive type, which logically it is because it</span></span><br><span class="line">        <span class="comment">// it represents no class.</span></span><br><span class="line">        java_lang_Class::<span class="built_in">set_klass</span>(<span class="built_in">mirror</span>(), <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set the classLoader field in the java_lang_Class instance</span></span><br><span class="line">    <span class="built_in">assert</span>(<span class="built_in">class_loader</span>() == k-&gt;<span class="built_in">class_loader</span>(), <span class="string">&quot;should be same&quot;</span>);</span><br><span class="line">    <span class="built_in">set_class_loader</span>(<span class="built_in">mirror</span>(), <span class="built_in">class_loader</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup indirection from klass-&gt;mirror last</span></span><br><span class="line">    <span class="comment">// after any exceptions can happen during allocations.</span></span><br><span class="line">    <span class="keyword">if</span> (!k.<span class="built_in">is_null</span>()) &#123;</span><br><span class="line">      k-&gt;<span class="built_in">set_java_mirror</span>(<span class="built_in">mirror</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fixup_mirror_list</span>() == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      GrowableArray&lt;Klass*&gt;* list =</span><br><span class="line">       <span class="built_in"><span class="keyword">new</span></span> (ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Klass*&gt;(<span class="number">40</span>, <span class="literal">true</span>);</span><br><span class="line">      <span class="built_in">set_fixup_mirror_list</span>(list);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fixup_mirror_list</span>()-&gt;<span class="built_in">push</span>(<span class="built_in">k</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</details>
<br/>
从代码的注释里面可以看到，mirror 镜像类也是一个 instanceKlass 的实例，`SystemDictionary::Class_klass()` 返回的就是 `java_lang_Class` 类型，然后 `allocate_instance()` 这个方法就是创建， `java.lang.Class` 这个 java 类型在 JVM 内部的对等体。再调用方法 `set_klass()`，让当前创建的 klassOop 引用刚刚实例化的  `java_lang_Class` 对象。**这么做的目的是为了被 Java 程序调用，而 instanceKlass 是 JVM 内部使用的。也就是说 JVM 暴露给 java 程序的是 mirror 实例，而不是 instanceKlass，这与前面的理论一致。** JDK 库中的反射等工具类，其实都是基于 `java_lang_Class` 这个内部镜像类实现的。

<p>另外在 <code>allocate_instance_klass()</code> 中，我们并没有看到静态字段的初始化，实际上静态字段的初始化是放到了镜像类中，创建镜像类的方法中有个方法 <code>initialize_mirror_fields()</code>，同样位于 <code>hotspot/src/share/vm/classfile/javaClasses.cpp</code>，贴下源码实现：</p>
<figure class="highlight c++"><figcaption><span>initialize_mirror_fields() 方法</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">java_lang_Class::initialize_mirror_fields</span><span class="params">(KlassHandle k,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               Handle mirror,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               Handle protection_domain,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               TRAPS)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Allocate a simple java object for a lock.</span></span><br><span class="line">  <span class="comment">// This needs to be a java object because during class initialization</span></span><br><span class="line">  <span class="comment">// it can be held across a java call.</span></span><br><span class="line">  typeArrayOop r = oopFactory::<span class="built_in">new_typeArray</span>(T_INT, <span class="number">0</span>, CHECK);</span><br><span class="line">  <span class="built_in">set_init_lock</span>(<span class="built_in">mirror</span>(), r);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set protection domain also</span></span><br><span class="line">  <span class="built_in">set_protection_domain</span>(<span class="built_in">mirror</span>(), <span class="built_in">protection_domain</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize static fields</span></span><br><span class="line">  InstanceKlass::<span class="built_in">cast</span>(<span class="built_in">k</span>())-&gt;<span class="built_in">do_local_static_fields</span>(&amp;initialize_static_field, mirror, CHECK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从代码中找到方法 <code>do_local_static_fields()</code>，这个方法就是初始化静态字段的方法，位于 <code>hotspot/src/share/vm/oops/instanceKlass.cpp</code> 中，如下：</p>
<figure class="highlight c++"><figcaption><span>do_local_static_fields() 实现</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InstanceKlass::do_local_static_fields</span><span class="params">(<span class="keyword">void</span> f(fieldDescriptor*, Handle, TRAPS), Handle mirror, TRAPS)</span> </span>&#123;</span><br><span class="line">  <span class="function">instanceKlassHandle <span class="title">h_this</span><span class="params">(THREAD, <span class="keyword">this</span>)</span></span>;</span><br><span class="line">  <span class="built_in">do_local_static_fields_impl</span>(h_this, f, mirror, CHECK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InstanceKlass::do_local_static_fields_impl</span><span class="params">(instanceKlassHandle this_k,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">void</span> f(fieldDescriptor* fd, Handle mirror, TRAPS), Handle mirror, TRAPS)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (JavaFieldStream <span class="built_in">fs</span>(<span class="built_in">this_k</span>()); !fs.<span class="built_in">done</span>(); fs.<span class="built_in">next</span>()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (fs.<span class="built_in">access_flags</span>().<span class="built_in">is_static</span>()) &#123;</span><br><span class="line">      fieldDescriptor&amp; fd = fs.<span class="built_in">field_descriptor</span>();</span><br><span class="line">      <span class="built_in">f</span>(&amp;fd, mirror, CHECK);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在 <code>javaClasses.cpp</code> 中调用 instanceKlass 的 <code>do_local_static_fields()</code> 方法时，传入了一个函数指针，这个函数指针代表如下，位于 <code>hotspot/src/share/vm/classfile/javaClasses.cpp</code>：</p>
<figure class="highlight c++"><figcaption><span>给静态字段赋初值的函数指针源码 &initialize_static_field</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initialize_static_field</span><span class="params">(fieldDescriptor* fd, Handle mirror, TRAPS)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">assert</span>(mirror.<span class="built_in">not_null</span>() &amp;&amp; fd-&gt;<span class="built_in">is_static</span>(), <span class="string">&quot;just checking&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd-&gt;<span class="built_in">has_initial_value</span>()) &#123;</span><br><span class="line">    BasicType t = fd-&gt;<span class="built_in">field_type</span>();</span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (t) &#123;</span><br><span class="line">      <span class="keyword">case</span> T_BYTE:</span><br><span class="line">        <span class="built_in">mirror</span>()-&gt;<span class="built_in">byte_field_put</span>(fd-&gt;<span class="built_in">offset</span>(), fd-&gt;<span class="built_in">int_initial_value</span>());</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> T_BOOLEAN:</span><br><span class="line">        <span class="built_in">mirror</span>()-&gt;<span class="built_in">bool_field_put</span>(fd-&gt;<span class="built_in">offset</span>(), fd-&gt;<span class="built_in">int_initial_value</span>());</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> T_CHAR:</span><br><span class="line">        <span class="built_in">mirror</span>()-&gt;<span class="built_in">char_field_put</span>(fd-&gt;<span class="built_in">offset</span>(), fd-&gt;<span class="built_in">int_initial_value</span>());</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> T_SHORT:</span><br><span class="line">        <span class="built_in">mirror</span>()-&gt;<span class="built_in">short_field_put</span>(fd-&gt;<span class="built_in">offset</span>(), fd-&gt;<span class="built_in">int_initial_value</span>());</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> T_INT:</span><br><span class="line">        <span class="built_in">mirror</span>()-&gt;<span class="built_in">int_field_put</span>(fd-&gt;<span class="built_in">offset</span>(), fd-&gt;<span class="built_in">int_initial_value</span>());</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> T_FLOAT:</span><br><span class="line">        <span class="built_in">mirror</span>()-&gt;<span class="built_in">float_field_put</span>(fd-&gt;<span class="built_in">offset</span>(), fd-&gt;<span class="built_in">float_initial_value</span>());</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> T_DOUBLE:</span><br><span class="line">        <span class="built_in">mirror</span>()-&gt;<span class="built_in">double_field_put</span>(fd-&gt;<span class="built_in">offset</span>(), fd-&gt;<span class="built_in">double_initial_value</span>());</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> T_LONG:</span><br><span class="line">        <span class="built_in">mirror</span>()-&gt;<span class="built_in">long_field_put</span>(fd-&gt;<span class="built_in">offset</span>(), fd-&gt;<span class="built_in">long_initial_value</span>());</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> T_OBJECT:</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="meta">#<span class="meta-keyword">ifdef</span> ASSERT</span></span><br><span class="line">          TempNewSymbol sym = SymbolTable::<span class="built_in">new_symbol</span>(<span class="string">&quot;Ljava/lang/String;&quot;</span>, CHECK);</span><br><span class="line">          <span class="built_in">assert</span>(fd-&gt;<span class="built_in">signature</span>() == sym, <span class="string">&quot;just checking&quot;</span>);</span><br><span class="line">          <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">          oop string = fd-&gt;<span class="built_in">string_initial_value</span>(CHECK);</span><br><span class="line">          <span class="built_in">mirror</span>()-&gt;<span class="built_in">obj_field_put</span>(fd-&gt;<span class="built_in">offset</span>(), string);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">THROW_MSG</span>(vmSymbols::<span class="built_in">java_lang_ClassFormatError</span>(),</span><br><span class="line">                  <span class="string">&quot;Illegal ConstantValue attribute in class file&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的函数中，通过 <code>mirror() -&gt; xxx_field_put()</code> 的方法将不同类型的静态字段存储到镜像类中。实际上，静态字段在类加载的阶段就已经完成了初始化。这里会有疑问：<strong>为什么要放在镜像类中？</strong>  因为前面说过镜像类是给 java 的应用程序调用，所以 JDK 类库等反射工具类都可以拿到这个类的所有字段，无论字段是不是静态的。</p>
<p>至此，类的生命周期中第一阶段：<strong>类加载</strong>，已经完成了。</p>
<blockquote>
<p>-XX:+TraceClassLoading 通过这个参数可以追踪加载的类</p>
</blockquote>
</div><div class="article-licensing box"><div class="licensing-title"><p>JVM系列 —— 类的生命周期之类加载</p><p><a href="https://caolizhi.top/2021-12-JVM系列-类加载/">https://caolizhi.top/2021-12-JVM系列-类加载/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>操先森</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-12-01</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-12-01</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/JVM/">JVM</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=6164f650ea6eca00151d8d08&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/images/wechat_pay.jpg" alt="微信"></span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/images/alipay.jpg" alt="支付宝"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021-12-JVM%E7%B3%BB%E5%88%97-%E9%93%BE%E6%8E%A5%E5%92%8C%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">JVM系列 —— 类的生命周期之链接和类初始化</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021-11-JVM%E7%B3%BB%E5%88%97-class%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/"><span class="level-item">JVM 系列 —— class 文件格式</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "0f23e682d9e087435de775d901f8e56f",
            repo: "caolizhi.github.io",
            owner: "caolizhi",
            clientID: "a494d62f203aa8c7e2e2",
            clientSecret: "7114657b7a13cc18ec25989917c5d2de0de93f5c",
            admin: ["caolizhi"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/images/avatar.png" alt="操先森"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">操先森</p><p class="is-size-6 is-block">Java Engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>四川·成都</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">24</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">13</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/caolizhi" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/caolizhi"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#写在前面"><span class="level-left"><span class="level-item">1</span><span class="level-item">写在前面</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#首先来看类加载机制"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">首先来看类加载机制</span></span></a></li><li><a class="level is-mobile" href="#其次来看类加载器"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">其次来看类加载器</span></span></a></li></ul></li><li><a class="level is-mobile" href="#虚拟机启动"><span class="level-left"><span class="level-item">2</span><span class="level-item">虚拟机启动</span></span></a></li><li><a class="level is-mobile" href="#oop-klass-模型"><span class="level-left"><span class="level-item">3</span><span class="level-item">oop-klass 模型</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#oop"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">oop</span></span></a></li><li><a class="level is-mobile" href="#klass"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">klass</span></span></a></li></ul></li><li><a class="level is-mobile" href="#类加载"><span class="level-left"><span class="level-item">4</span><span class="level-item">类加载</span></span></a></li><li><a class="level is-mobile" href="#镜像类和静态字段"><span class="level-left"><span class="level-item">5</span><span class="level-item">镜像类和静态字段</span></span></a></li></ul></div></div><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">11</span></span></a><ul><li><a class="level is-mobile" href="/categories/Java/JVM/"><span class="level-start"><span class="level-item">JVM</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/"><span class="level-start"><span class="level-item">内存模型</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="level-start"><span class="level-item">多线程</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"><span class="level-start"><span class="level-item">云原生</span></span><span class="level-end"><span class="level-item tag">4</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/K8S/"><span class="level-start"><span class="level-item">K8S</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/"><span class="level-start"><span class="level-item">响应式编程</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="level-start"><span class="level-item">数据库</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/"><span class="level-start"><span class="level-item">MongoDB</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/"><span class="level-start"><span class="level-item">MySQL</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"><span class="level-start"><span class="level-item">网络编程</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-23T02:34:08.000Z">2021-12-23</time></p><p class="title"><a href="/2021-12-JVM%E7%B3%BB%E5%88%97-%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA/">JVM系列 —— 运行时数据区</a></p><p class="categories"><a href="/categories/Java/">Java</a> / <a href="/categories/Java/JVM/">JVM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-15T06:40:59.000Z">2021-12-15</time></p><p class="title"><a href="/2021-12-JVM%E7%B3%BB%E5%88%97-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/">JVM系列-双亲委派模型</a></p><p class="categories"><a href="/categories/Java/">Java</a> / <a href="/categories/Java/JVM/">JVM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-09T01:12:07.000Z">2021-12-09</time></p><p class="title"><a href="/2021-12-%E6%89%8B%E6%8A%8A%E6%89%8B%E5%B8%A6%E4%BD%A0%E8%AF%BBclass%E6%96%87%E4%BB%B6%E5%AD%97%E8%8A%82%E7%A0%81/">手把手带你读class文件字节码</a></p><p class="categories"><a href="/categories/Java/">Java</a> / <a href="/categories/Java/JVM/">JVM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-02T03:08:13.000Z">2021-12-02</time></p><p class="title"><a href="/2021-12-JVM%E7%B3%BB%E5%88%97-%E9%93%BE%E6%8E%A5%E5%92%8C%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96/">JVM系列 —— 类的生命周期之链接和类初始化</a></p><p class="categories"><a href="/categories/Java/">Java</a> / <a href="/categories/Java/JVM/">JVM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-01T01:21:27.000Z">2021-12-01</time></p><p class="title"><a href="/2021-12-JVM%E7%B3%BB%E5%88%97-%E7%B1%BB%E5%8A%A0%E8%BD%BD/">JVM系列 —— 类的生命周期之类加载</a></p><p class="categories"><a href="/categories/Java/">Java</a> / <a href="/categories/Java/JVM/">JVM</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">十二月 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/AQS/"><span class="tag">AQS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CAS/"><span class="tag">CAS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/I-O/"><span class="tag">I/O</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JUC/"><span class="tag">JUC</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JVM/"><span class="tag">JVM</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/K8S/"><span class="tag">K8S</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MongoDB/"><span class="tag">MongoDB</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/reactive/"><span class="tag">reactive</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"><span class="tag">线程池</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/"><span class="tag">虚拟机</span><span class="tag">3</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/logo.svg" alt="操先森的博客" height="28"></a><p class="is-size-7"><span>&copy; 2021 操先森</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/caolizhi"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>