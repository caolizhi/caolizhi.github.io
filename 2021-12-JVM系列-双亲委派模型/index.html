<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>JVM系列-双亲委派模型 - 操先森的博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="操先森的博客"><meta name="msapplication-TileImage" content="/images/logo.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="操先森的博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="这是 JVM 系列的第六篇，见 JVM 系列。 写在前面在前面的文章里面，JVM 拿到 class 文件流之后，完成了以下的工作：  校验魔数 校验版本 解析常量池 解析字段 解析方法 解析属性 创建与 java 对象对等的内部对象 instanceKlass，提供给 JVM 使用 创建镜像类，提供给Java应用使用  要想在JVM内部创建对等的 oop-klass 对象，就必须要经过类加载器的加"><meta property="og:type" content="blog"><meta property="og:title" content="JVM系列-双亲委派模型"><meta property="og:url" content="https://caolizhi.top/2021-12-JVM%E7%B3%BB%E5%88%97-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/"><meta property="og:site_name" content="操先森的博客"><meta property="og:description" content="这是 JVM 系列的第六篇，见 JVM 系列。 写在前面在前面的文章里面，JVM 拿到 class 文件流之后，完成了以下的工作：  校验魔数 校验版本 解析常量池 解析字段 解析方法 解析属性 创建与 java 对象对等的内部对象 instanceKlass，提供给 JVM 使用 创建镜像类，提供给Java应用使用  要想在JVM内部创建对等的 oop-klass 对象，就必须要经过类加载器的加"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://caolizhi.top/images/og_image.png"><meta property="article:published_time" content="2021-12-15T06:40:59.000Z"><meta property="article:modified_time" content="2021-12-21T11:30:59.000Z"><meta property="article:author" content="操先森"><meta property="article:tag" content="JVM"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://caolizhi.top/2021-12-JVM%E7%B3%BB%E5%88%97-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/"},"headline":"JVM系列-双亲委派模型","image":["https://caolizhi.top/images/og_image.png"],"datePublished":"2021-12-15T06:40:59.000Z","dateModified":"2021-12-21T11:30:59.000Z","author":{"@type":"Person","name":"操先森"},"publisher":{"@type":"Organization","name":"操先森的博客","logo":{"@type":"ImageObject","url":"https://caolizhi.top/images/logo.svg"}},"description":"这是 JVM 系列的第六篇，见 JVM 系列。 写在前面在前面的文章里面，JVM 拿到 class 文件流之后，完成了以下的工作：  校验魔数 校验版本 解析常量池 解析字段 解析方法 解析属性 创建与 java 对象对等的内部对象 instanceKlass，提供给 JVM 使用 创建镜像类，提供给Java应用使用  要想在JVM内部创建对等的 oop-klass 对象，就必须要经过类加载器的加"}</script><link rel="canonical" href="https://caolizhi.top/2021-12-JVM%E7%B3%BB%E5%88%97-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/"><link rel="icon" href="/images/logo.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?c2c31a128dbe61bc1214fcf1f334afd1";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-210020245-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-210020245-1');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/logo.svg" alt="操先森的博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/caolizhi"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-12-15T06:40:59.000Z" title="2021/12/15 下午2:40:59">2021-12-15</time>发表</span><span class="level-item"><time dateTime="2021-12-21T11:30:59.000Z" title="2021/12/21 下午7:30:59">2021-12-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Java/">Java</a><span> / </span><a class="link-muted" href="/categories/Java/JVM/">JVM</a></span><span class="level-item">43 分钟读完 (大约6508个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">JVM系列-双亲委派模型</h1><div class="content"><p>这是 JVM 系列的第六篇，<a href="https://caolizhi.top/categories/Java/JVM/">见 JVM 系列</a>。</p>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>在前面的文章里面，JVM 拿到 class 文件流之后，完成了以下的工作：</p>
<ul>
<li>校验魔数</li>
<li>校验版本</li>
<li>解析常量池</li>
<li>解析字段</li>
<li>解析方法</li>
<li>解析属性</li>
<li>创建与 java 对象对等的内部对象 instanceKlass，提供给 JVM 使用</li>
<li>创建镜像类，提供给Java应用使用</li>
</ul>
<p>要想在JVM内部创建对等的 oop-klass 对象，就必须要经过类加载器的加载过程。前面提到 java 体系中，我们了解到有 3 类类加载：<strong>引导类加载器（Bootstrap ClassLoader）</strong>、<strong>扩展类加载器（Bootstrap ClassLoader）</strong>、<strong>系统类加载器（Bootstrap ClassLoader）</strong>。实际上 JVM 规范只提到了 2 种，引导类加载器和自定义类加载器。当然引导类加载器事 C++ 写的，自定义类加载器用 java 语言定义。</p>
<span id="more"></span>

<h2 id="C-定义的引导类加载器"><a href="#C-定义的引导类加载器" class="headerlink" title="C++ 定义的引导类加载器"></a>C++ 定义的引导类加载器</h2><p>C++ 的类加载器位于：<code>hotspot/src/share/vm/classfile/classLoader.hpp</code>，如下：</p>
<details>
<summary>C++ 引导类加载器的定义</summary>

   <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span>:</span> AllStatic &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">SomeConstants</span> &#123;</span></span><br><span class="line">    package_hash_table_size = <span class="number">31</span>  <span class="comment">// Number of buckets</span></span><br><span class="line">  &#125;;</span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyClassPathEntry</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Performance counters</span></span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_accumulated_time;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_classes_inited;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_class_init_time;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_class_init_selftime;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_classes_verified;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_class_verify_time;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_class_verify_selftime;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_classes_linked;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_class_link_time;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_class_link_selftime;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_class_parse_time;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_class_parse_selftime;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_sys_class_lookup_time;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_shared_classload_time;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_sys_classload_time;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_app_classload_time;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_app_classload_selftime;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_app_classload_count;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_define_appclasses;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_define_appclass_time;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_define_appclass_selftime;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_app_classfile_bytes_read;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _perf_sys_classfile_bytes_read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> PerfCounter* _sync_systemLoaderLockContentionRate;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _sync_nonSystemLoaderLockContentionRate;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _sync_JVMFindLoadedClassLockFreeCounter;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _sync_JVMDefineClassLockFreeCounter;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _sync_JNIDefineClassLockFreeCounter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> PerfCounter* _unsafe_defineClassCallCounter;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _isUnsyncloadClass;</span><br><span class="line"><span class="keyword">static</span> PerfCounter* _load_instance_class_failCounter;</span><br><span class="line"></span><br><span class="line"><span class="comment">// First entry in linked list of ClassPathEntry instances</span></span><br><span class="line"><span class="keyword">static</span> ClassPathEntry* _first_entry;</span><br><span class="line"><span class="comment">// Last entry in linked list of ClassPathEntry instances</span></span><br><span class="line"><span class="keyword">static</span> ClassPathEntry* _last_entry;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> _num_entries;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hash table used to keep track of loaded packages</span></span><br><span class="line"><span class="keyword">static</span> PackageHashtable* _package_hash_table;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* _shared_archive;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Info used by CDS</span></span><br><span class="line"><span class="built_in">CDS_ONLY</span>(<span class="keyword">static</span> SharedPathsMiscInfo * _shared_paths_misc_info;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hash function</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">int</span> n)</span></span>;</span><br><span class="line"><span class="comment">// Returns the package file name corresponding to the specified package</span></span><br><span class="line"><span class="comment">// or class name, or null if not found.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> PackageInfo* <span class="title">lookup_package</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pkgname)</span></span>;</span><br><span class="line"><span class="comment">// Adds a new package entry for the specified class or package name and</span></span><br><span class="line"><span class="comment">// corresponding directory or jar file name.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">add_package</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pkgname, <span class="keyword">int</span> classpath_index, TRAPS)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialization</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setup_bootstrap_meta_index</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setup_meta_index</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* meta_index_path, <span class="keyword">const</span> <span class="keyword">char</span>* meta_index_dir,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> start_index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setup_bootstrap_search_path</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setup_search_path</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *class_path, <span class="keyword">bool</span> canonicalize=<span class="literal">false</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">load_zip_library</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> ClassPathEntry* <span class="title">create_class_path_entry</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> struct stat* st,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">bool</span> lazy, <span class="keyword">bool</span> throw_exception, TRAPS)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Canonicalizes path names, so strcmp will work properly. This is mainly</span></span><br><span class="line"><span class="comment">// to avoid confusing the zip library</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">get_canonical_path</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* orig, <span class="keyword">char</span>* out, <span class="keyword">int</span> len)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">crc32</span><span class="params">(<span class="keyword">int</span> crc, <span class="keyword">const</span> <span class="keyword">char</span>* buf, <span class="keyword">int</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">update_class_path_entry_list</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">bool</span> check_for_duplicates,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">bool</span> throw_exception=<span class="literal">true</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print_bootclasspath</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Timing</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_accumulated_time</span><span class="params">()</span>         </span>&#123; <span class="keyword">return</span> _perf_accumulated_time; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_classes_inited</span><span class="params">()</span>           </span>&#123; <span class="keyword">return</span> _perf_classes_inited; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_class_init_time</span><span class="params">()</span>          </span>&#123; <span class="keyword">return</span> _perf_class_init_time; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_class_init_selftime</span><span class="params">()</span>      </span>&#123; <span class="keyword">return</span> _perf_class_init_selftime; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_classes_verified</span><span class="params">()</span>         </span>&#123; <span class="keyword">return</span> _perf_classes_verified; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_class_verify_time</span><span class="params">()</span>        </span>&#123; <span class="keyword">return</span> _perf_class_verify_time; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_class_verify_selftime</span><span class="params">()</span>    </span>&#123; <span class="keyword">return</span> _perf_class_verify_selftime; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_classes_linked</span><span class="params">()</span>           </span>&#123; <span class="keyword">return</span> _perf_classes_linked; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_class_link_time</span><span class="params">()</span>          </span>&#123; <span class="keyword">return</span> _perf_class_link_time; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_class_link_selftime</span><span class="params">()</span>      </span>&#123; <span class="keyword">return</span> _perf_class_link_selftime; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_class_parse_time</span><span class="params">()</span>         </span>&#123; <span class="keyword">return</span> _perf_class_parse_time; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_class_parse_selftime</span><span class="params">()</span>     </span>&#123; <span class="keyword">return</span> _perf_class_parse_selftime; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_sys_class_lookup_time</span><span class="params">()</span>    </span>&#123; <span class="keyword">return</span> _perf_sys_class_lookup_time; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_shared_classload_time</span><span class="params">()</span>    </span>&#123; <span class="keyword">return</span> _perf_shared_classload_time; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_sys_classload_time</span><span class="params">()</span>       </span>&#123; <span class="keyword">return</span> _perf_sys_classload_time; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_app_classload_time</span><span class="params">()</span>       </span>&#123; <span class="keyword">return</span> _perf_app_classload_time; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_app_classload_selftime</span><span class="params">()</span>   </span>&#123; <span class="keyword">return</span> _perf_app_classload_selftime; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_app_classload_count</span><span class="params">()</span>      </span>&#123; <span class="keyword">return</span> _perf_app_classload_count; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_define_appclasses</span><span class="params">()</span>        </span>&#123; <span class="keyword">return</span> _perf_define_appclasses; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_define_appclass_time</span><span class="params">()</span>     </span>&#123; <span class="keyword">return</span> _perf_define_appclass_time; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_define_appclass_selftime</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _perf_define_appclass_selftime; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_app_classfile_bytes_read</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _perf_app_classfile_bytes_read; &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">perf_sys_classfile_bytes_read</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _perf_sys_classfile_bytes_read; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Record how often system loader lock object is contended</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">sync_systemLoaderLockContentionRate</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> _sync_systemLoaderLockContentionRate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Record how often non system loader lock object is contended</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">sync_nonSystemLoaderLockContentionRate</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> _sync_nonSystemLoaderLockContentionRate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Record how many calls to JVM_FindLoadedClass w/o holding a lock</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">sync_JVMFindLoadedClassLockFreeCounter</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> _sync_JVMFindLoadedClassLockFreeCounter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Record how many calls to JVM_DefineClass w/o holding a lock</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">sync_JVMDefineClassLockFreeCounter</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> _sync_JVMDefineClassLockFreeCounter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Record how many calls to jni_DefineClass w/o holding a lock</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">sync_JNIDefineClassLockFreeCounter</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> _sync_JNIDefineClassLockFreeCounter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Record how many calls to Unsafe_DefineClass</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">unsafe_defineClassCallCounter</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> _unsafe_defineClassCallCounter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Record how many times SystemDictionary::load_instance_class call</span></span><br><span class="line"><span class="comment">// fails with linkageError when Unsyncloadclass flag is set.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> PerfCounter* <span class="title">load_instance_class_failCounter</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> _load_instance_class_failCounter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Load individual .class file</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> instanceKlassHandle <span class="title">load_classfile</span><span class="params">(Symbol* h_name, TRAPS)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If the specified package has been loaded by the system, then returns</span></span><br><span class="line"><span class="comment">// the name of the directory or ZIP file that the package was loaded from.</span></span><br><span class="line"><span class="comment">// Returns null if the package was not loaded.</span></span><br><span class="line"><span class="comment">// Note: The specified name can either be the name of a class or package.</span></span><br><span class="line"><span class="comment">// If a package name is specified, then it must be &quot;/&quot;-separator and also</span></span><br><span class="line"><span class="comment">// end with a trailing &quot;/&quot;.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> oop <span class="title">get_system_package</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* name, TRAPS)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns an array of Java strings representing all of the currently</span></span><br><span class="line"><span class="comment">// loaded system packages.</span></span><br><span class="line"><span class="comment">// Note: The package names returned are &quot;/&quot;-separated and end with a</span></span><br><span class="line"><span class="comment">// trailing &quot;/&quot;.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> objArrayOop <span class="title">get_system_packages</span><span class="params">(TRAPS)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialization</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span></span>;</span><br><span class="line"><span class="built_in">CDS_ONLY</span>(<span class="keyword">static</span> <span class="keyword">void</span> <span class="built_in">initialize_shared_path</span>();)</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">create_package_info_table</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">create_package_info_table</span><span class="params">(HashtableBucket&lt;mtClass&gt; *t, <span class="keyword">int</span> length,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> number_of_entries)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">compute_Object_vtable</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> ClassPathEntry* <span class="title">classpath_entry</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">ClassPathEntry* e = ClassLoader::_first_entry;</span><br><span class="line"><span class="keyword">while</span> (--n &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">assert</span>(e != <span class="literal">NULL</span>, <span class="string">&quot;Not that many classpath entries.&quot;</span>);</span><br><span class="line">e = e-&gt;<span class="built_in">next</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> e;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">num_classpath_entries</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> _num_entries;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_CDS</span></span><br><span class="line"><span class="comment">// Sharing dump and restore</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copy_package_info_buckets</span><span class="params">(<span class="keyword">char</span>** top, <span class="keyword">char</span>* end)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copy_package_info_table</span><span class="params">(<span class="keyword">char</span>** top, <span class="keyword">char</span>* end)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">check_shared_classpath</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">finalize_shared_paths_misc_info</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span>   <span class="title">get_shared_paths_misc_info_size</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">get_shared_paths_misc_info</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span>  <span class="title">check_shared_paths_misc_info</span><span class="params">(<span class="keyword">void</span>* info, <span class="keyword">int</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">exit_with_path_failure</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* error, <span class="keyword">const</span> <span class="keyword">char</span>* message)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">trace_class_path</span><span class="params">(outputStream* out, <span class="keyword">const</span> <span class="keyword">char</span>* msg, <span class="keyword">const</span> <span class="keyword">char</span>* name = <span class="literal">NULL</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// VM monitoring and management support</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">classloader_time_ms</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">class_method_total_size</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">class_init_count</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">class_init_time_ms</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">class_verify_time_ms</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">class_link_count</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">class_link_time_ms</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// indicates if class path already contains a entry (exact match by name)</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">contains_entry</span><span class="params">(ClassPathEntry* entry)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// adds a class path list</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add_to_list</span><span class="params">(ClassPathEntry* new_entry)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// creates a class path zip entry (returns NULL if JAR file cannot be opened)</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> ClassPathZipEntry* <span class="title">create_class_path_zip_entry</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *apath)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// obtain package name from a fully qualified class name</span></span><br><span class="line"><span class="comment">// *bad_class_name is set to true if there&#x27;s a problem with parsing class_name, to</span></span><br><span class="line"><span class="comment">// distinguish from a class_name with no package name, as both cases have a NULL return value</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">package_from_name</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> class_name, <span class="keyword">bool</span>* bad_class_name = <span class="literal">NULL</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Debugging</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">verify</span><span class="params">()</span>              PRODUCT_RETURN</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Force compilation of all methods in all classes in bootstrap class path (stress test)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PRODUCT</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> _compile_the_world_class_counter;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> _compile_the_world_method_counter;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">compile_the_world</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">compile_the_world_in</span><span class="params">(<span class="keyword">char</span>* name, Handle loader, TRAPS)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span>  <span class="title">compile_the_world_counter</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _compile_the_world_class_counter; &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//PRODUCT</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</details>

<p>核心的方法：</p>
<figure class="highlight c++"><figcaption><span>加载类文件</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Load individual .class file</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> instanceKlassHandle <span class="title">load_classfile</span><span class="params">(Symbol* h_name, TRAPS)</span></span>;</span><br></pre></td></tr></table></figure>

<p>再看看 <code>load_classfile()</code> 函数里面的内容：</p>
<details>
<summary>load_classfile() 函数定义</summary>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">instanceKlassHandle <span class="title">ClassLoader::load_classfile</span><span class="params">(Symbol* h_name, TRAPS)</span> </span>&#123;</span><br><span class="line">  <span class="function">ResourceMark <span class="title">rm</span><span class="params">(THREAD)</span></span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* class_name = h_name-&gt;<span class="built_in">as_C_string</span>();</span><br><span class="line">  <span class="function">EventMark <span class="title">m</span><span class="params">(<span class="string">&quot;loading class %s&quot;</span>, class_name)</span></span>;</span><br><span class="line">  <span class="function">ThreadProfilerMark <span class="title">tpm</span><span class="params">(ThreadProfilerMark::classLoaderRegion)</span></span>;</span><br><span class="line"></span><br><span class="line">  stringStream st;</span><br><span class="line">  <span class="comment">// st.print() uses too much stack space while handling a StackOverflowError</span></span><br><span class="line">  <span class="comment">// st.print(&quot;%s.class&quot;, h_name-&gt;as_utf8());</span></span><br><span class="line">  st.<span class="built_in">print_raw</span>(h_name-&gt;<span class="built_in">as_utf8</span>());</span><br><span class="line">  st.<span class="built_in">print_raw</span>(<span class="string">&quot;.class&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* file_name = st.<span class="built_in">as_string</span>();</span><br><span class="line">  <span class="function">ClassLoaderExt::Context <span class="title">context</span><span class="params">(class_name, file_name, THREAD)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Lookup stream for parsing .class file</span></span><br><span class="line">  ClassFileStream* stream = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">int</span> classpath_index = <span class="number">0</span>;</span><br><span class="line">  ClassPathEntry* e = <span class="literal">NULL</span>;</span><br><span class="line">  instanceKlassHandle h;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">PerfClassTraceTime <span class="title">vmtimer</span><span class="params">(perf_sys_class_lookup_time(),</span></span></span><br><span class="line"><span class="params"><span class="function">                               ((JavaThread*) THREAD)-&gt;get_thread_stat()-&gt;perf_timers_addr(),</span></span></span><br><span class="line"><span class="params"><span class="function">                               PerfClassTraceTime::CLASS_LOAD)</span></span>;</span><br><span class="line">    e = _first_entry;</span><br><span class="line">    <span class="keyword">while</span> (e != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      stream = e-&gt;<span class="built_in">open_stream</span>(file_name, CHECK_NULL);</span><br><span class="line">      <span class="keyword">if</span> (!context.<span class="built_in">check</span>(stream, classpath_index)) &#123;</span><br><span class="line">        <span class="keyword">return</span> h; <span class="comment">// NULL</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (stream != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      e = e-&gt;<span class="built_in">next</span>();</span><br><span class="line">      ++classpath_index;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stream != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="comment">// class file found, parse it</span></span><br><span class="line">    <span class="function">ClassFileParser <span class="title">parser</span><span class="params">(stream)</span></span>;</span><br><span class="line">    ClassLoaderData* loader_data = ClassLoaderData::<span class="built_in">the_null_class_loader_data</span>();</span><br><span class="line">    Handle protection_domain;</span><br><span class="line">    TempNewSymbol parsed_name = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// Callers are expected to declare a ResourceMark to determine</span></span><br><span class="line">    <span class="comment">// the lifetime of any updated (resource) allocated under</span></span><br><span class="line">    <span class="comment">// this call to parseClassFile</span></span><br><span class="line">    <span class="comment">// We do not declare another ResourceMark here, reusing the one declared</span></span><br><span class="line">    <span class="comment">// at the start of the method</span></span><br><span class="line">    instanceKlassHandle result = parser.<span class="built_in">parseClassFile</span>(h_name,</span><br><span class="line">                                                       loader_data,</span><br><span class="line">                                                       protection_domain,</span><br><span class="line">                                                       parsed_name,</span><br><span class="line">                                                       context.<span class="built_in">should_verify</span>(classpath_index),</span><br><span class="line">                                                       THREAD);</span><br><span class="line">    <span class="keyword">if</span> (HAS_PENDING_EXCEPTION) &#123;</span><br><span class="line">      ResourceMark rm;</span><br><span class="line">      <span class="keyword">if</span> (DumpSharedSpaces) &#123;</span><br><span class="line">        tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;Preload Error: Failed to load %s&quot;</span>, class_name);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_JFR</span></span><br><span class="line">  &#123;</span><br><span class="line">    InstanceKlass* ik = <span class="built_in">result</span>();</span><br><span class="line">    <span class="built_in">ON_KLASS_CREATION</span>(ik, parser, THREAD);</span><br><span class="line">    result = <span class="built_in">instanceKlassHandle</span>(ik);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    h = context.<span class="built_in">record_result</span>(classpath_index, e, result, THREAD);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (DumpSharedSpaces) &#123;</span><br><span class="line">      tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;Preload Warning: Cannot find %s&quot;</span>, class_name);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

<br/>

<p><code>load_classfile()</code> 函数里面最重要的函数就是：<code>parseClassFile()</code>：</p>
<details>
<summary>parseClassFile() 函数定义</summary>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">instanceKlassHandle <span class="title">ClassFileParser::parseClassFile</span><span class="params">(Symbol* name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    ClassLoaderData* loader_data,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    Handle protection_domain,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    KlassHandle host_klass,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    GrowableArray&lt;Handle&gt;* cp_patches,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    TempNewSymbol&amp; parsed_name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    <span class="keyword">bool</span> verify,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    TRAPS)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// When a retransformable agent is attached, JVMTI caches the</span></span><br><span class="line">  <span class="comment">// class bytes that existed before the first retransformation.</span></span><br><span class="line">  <span class="comment">// If RedefineClasses() was used before the retransformable</span></span><br><span class="line">  <span class="comment">// agent attached, then the cached class bytes may not be the</span></span><br><span class="line">  <span class="comment">// original class bytes.</span></span><br><span class="line">  JvmtiCachedClassFileData *cached_class_file = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="function">Handle <span class="title">class_loader</span><span class="params">(THREAD, loader_data-&gt;class_loader())</span></span>;</span><br><span class="line">  <span class="keyword">bool</span> has_default_methods = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">bool</span> declares_default_methods = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// JDK-8252904:</span></span><br><span class="line">  <span class="comment">// The stream (resource) attached to the instance klass may</span></span><br><span class="line">  <span class="comment">// be reallocated by this method. When JFR is included the</span></span><br><span class="line">  <span class="comment">// stream may need to survive beyond the end of the call. So,</span></span><br><span class="line">  <span class="comment">// the caller is expected to declare the ResourceMark that</span></span><br><span class="line">  <span class="comment">// determines the lifetime of resources allocated under this</span></span><br><span class="line">  <span class="comment">// call.</span></span><br><span class="line"></span><br><span class="line">  ClassFileStream* cfs = <span class="built_in">stream</span>();</span><br><span class="line">  <span class="comment">// Timing</span></span><br><span class="line">  <span class="built_in">assert</span>(THREAD-&gt;<span class="built_in">is_Java_thread</span>(), <span class="string">&quot;must be a JavaThread&quot;</span>);</span><br><span class="line">  JavaThread* jt = (JavaThread*) THREAD;</span><br><span class="line"></span><br><span class="line">  <span class="function">PerfClassTraceTime <span class="title">ctimer</span><span class="params">(ClassLoader::perf_class_parse_time(),</span></span></span><br><span class="line"><span class="params"><span class="function">                            ClassLoader::perf_class_parse_selftime(),</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="literal">NULL</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                            jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),</span></span></span><br><span class="line"><span class="params"><span class="function">                            jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),</span></span></span><br><span class="line"><span class="params"><span class="function">                            PerfClassTraceTime::PARSE_CLASS)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">init_parsed_class_attributes</span>(loader_data);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (JvmtiExport::<span class="built_in">should_post_class_file_load_hook</span>()) &#123;</span><br><span class="line">    <span class="comment">// Get the cached class file bytes (if any) from the class that</span></span><br><span class="line">    <span class="comment">// is being redefined or retransformed. We use jvmti_thread_state()</span></span><br><span class="line">    <span class="comment">// instead of JvmtiThreadState::state_for(jt) so we don&#x27;t allocate</span></span><br><span class="line">    <span class="comment">// a JvmtiThreadState any earlier than necessary. This will help</span></span><br><span class="line">    <span class="comment">// avoid the bug described by 7126851.</span></span><br><span class="line">    JvmtiThreadState *state = jt-&gt;<span class="built_in">jvmti_thread_state</span>();</span><br><span class="line">    <span class="keyword">if</span> (state != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      KlassHandle *h_class_being_redefined =</span><br><span class="line">                     state-&gt;<span class="built_in">get_class_being_redefined</span>();</span><br><span class="line">      <span class="keyword">if</span> (h_class_being_redefined != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        instanceKlassHandle ikh_class_being_redefined =</span><br><span class="line">          <span class="built_in">instanceKlassHandle</span>(THREAD, (*h_class_being_redefined)());</span><br><span class="line">        cached_class_file = ikh_class_being_redefined-&gt;<span class="built_in">get_cached_class_file</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>* ptr = cfs-&gt;<span class="built_in">buffer</span>();</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>* end_ptr = cfs-&gt;<span class="built_in">buffer</span>() + cfs-&gt;<span class="built_in">length</span>();</span><br><span class="line"></span><br><span class="line">    JvmtiExport::<span class="built_in">post_class_file_load_hook</span>(name, <span class="built_in">class_loader</span>(), protection_domain,</span><br><span class="line">                                           &amp;ptr, &amp;end_ptr, &amp;cached_class_file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ptr != cfs-&gt;<span class="built_in">buffer</span>()) &#123;</span><br><span class="line">      <span class="comment">// JVMTI agent has modified class file data.</span></span><br><span class="line">      <span class="comment">// Set new class file stream using JVMTI agent modified</span></span><br><span class="line">      <span class="comment">// class file data.</span></span><br><span class="line">      cfs = <span class="keyword">new</span> <span class="built_in">ClassFileStream</span>(ptr, end_ptr - ptr, cfs-&gt;<span class="built_in">source</span>());</span><br><span class="line">      <span class="built_in">set_stream</span>(cfs);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _host_klass = host_klass;</span><br><span class="line">  _cp_patches = cp_patches;</span><br><span class="line"></span><br><span class="line">  instanceKlassHandle nullHandle;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Figure out whether we can skip format checking (matching classic VM behavior)</span></span><br><span class="line">  <span class="keyword">if</span> (DumpSharedSpaces) &#123;</span><br><span class="line">    <span class="comment">// verify == true means it&#x27;s a &#x27;remote&#x27; class (i.e., non-boot class)</span></span><br><span class="line">    <span class="comment">// Verification decision is based on BytecodeVerificationRemote flag</span></span><br><span class="line">    <span class="comment">// for those classes.</span></span><br><span class="line">    _need_verify = (verify) ? BytecodeVerificationRemote :</span><br><span class="line">                              BytecodeVerificationLocal;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    _need_verify = Verifier::<span class="built_in">should_verify_for</span>(<span class="built_in">class_loader</span>(), verify);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the verify flag in stream</span></span><br><span class="line">  cfs-&gt;<span class="built_in">set_verify</span>(_need_verify);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Save the class file name for easier error message printing.</span></span><br><span class="line">  _class_name = (name != <span class="literal">NULL</span>) ? name : vmSymbols::<span class="built_in">unknown_class_name</span>();</span><br><span class="line"></span><br><span class="line">  cfs-&gt;<span class="built_in">guarantee_more</span>(<span class="number">8</span>, <span class="built_in">CHECK_</span>(nullHandle));  <span class="comment">// magic, major, minor</span></span><br><span class="line">  <span class="comment">// Magic value</span></span><br><span class="line">  u4 magic = cfs-&gt;<span class="built_in">get_u4_fast</span>();</span><br><span class="line">  <span class="built_in">guarantee_property</span>(magic == JAVA_CLASSFILE_MAGIC,</span><br><span class="line">                     <span class="string">&quot;Incompatible magic value %u in class file %s&quot;</span>,</span><br><span class="line">                     magic, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Version numbers</span></span><br><span class="line">  u2 minor_version = cfs-&gt;<span class="built_in">get_u2_fast</span>();</span><br><span class="line">  u2 major_version = cfs-&gt;<span class="built_in">get_u2_fast</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (DumpSharedSpaces &amp;&amp; major_version &lt; JAVA_1_5_VERSION) &#123;</span><br><span class="line">    ResourceMark rm;</span><br><span class="line">    <span class="built_in">warning</span>(<span class="string">&quot;Pre JDK 1.5 class not supported by CDS: %u.%u %s&quot;</span>,</span><br><span class="line">            major_version,  minor_version, name-&gt;<span class="built_in">as_C_string</span>());</span><br><span class="line">    Exceptions::<span class="built_in">fthrow</span>(</span><br><span class="line">      THREAD_AND_LOCATION,</span><br><span class="line">      vmSymbols::<span class="built_in">java_lang_UnsupportedClassVersionError</span>(),</span><br><span class="line">      <span class="string">&quot;Unsupported major.minor version for dump time %u.%u&quot;</span>,</span><br><span class="line">      major_version,</span><br><span class="line">      minor_version);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check version numbers - we check this even with verifier off</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">is_supported_version</span>(major_version, minor_version)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      Exceptions::<span class="built_in">fthrow</span>(</span><br><span class="line">        THREAD_AND_LOCATION,</span><br><span class="line">        vmSymbols::<span class="built_in">java_lang_UnsupportedClassVersionError</span>(),</span><br><span class="line">        <span class="string">&quot;Unsupported class file version %u.%u, &quot;</span></span><br><span class="line">        <span class="string">&quot;this version of the Java Runtime only recognizes class file versions up to %u.%u&quot;</span>,</span><br><span class="line">        major_version,</span><br><span class="line">        minor_version,</span><br><span class="line">        JAVA_MAX_SUPPORTED_VERSION,</span><br><span class="line">        JAVA_MAX_SUPPORTED_MINOR_VERSION);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ResourceMark <span class="built_in">rm</span>(THREAD);</span><br><span class="line">      Exceptions::<span class="built_in">fthrow</span>(</span><br><span class="line">        THREAD_AND_LOCATION,</span><br><span class="line">        vmSymbols::<span class="built_in">java_lang_UnsupportedClassVersionError</span>(),</span><br><span class="line">        <span class="string">&quot;%s has been compiled by a more recent version of the Java Runtime (class file version %u.%u), &quot;</span></span><br><span class="line">        <span class="string">&quot;this version of the Java Runtime only recognizes class file versions up to %u.%u&quot;</span>,</span><br><span class="line">        name-&gt;<span class="built_in">as_C_string</span>(),</span><br><span class="line">        major_version,</span><br><span class="line">        minor_version,</span><br><span class="line">        JAVA_MAX_SUPPORTED_VERSION,</span><br><span class="line">        JAVA_MAX_SUPPORTED_MINOR_VERSION);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nullHandle;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _major_version = major_version;</span><br><span class="line">  _minor_version = minor_version;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if verification needs to be relaxed for this class file</span></span><br><span class="line">  <span class="comment">// Do not restrict it to jdk1.0 or jdk1.1 to maintain backward compatibility (4982376)</span></span><br><span class="line">  _relax_verify = <span class="built_in">relax_format_check_for</span>(_loader_data);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Constant pool</span></span><br><span class="line">  constantPoolHandle cp = <span class="built_in">parse_constant_pool</span>(<span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> cp_size = cp-&gt;<span class="built_in">length</span>();</span><br><span class="line"></span><br><span class="line">  cfs-&gt;<span class="built_in">guarantee_more</span>(<span class="number">8</span>, <span class="built_in">CHECK_</span>(nullHandle));  <span class="comment">// flags, this_class, super_class, infs_len</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Access flags</span></span><br><span class="line">  AccessFlags access_flags;</span><br><span class="line">  jint flags = cfs-&gt;<span class="built_in">get_u2_fast</span>() &amp; JVM_RECOGNIZED_CLASS_MODIFIERS;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((flags &amp; JVM_ACC_INTERFACE) &amp;&amp; _major_version &lt; JAVA_6_VERSION) &#123;</span><br><span class="line">    <span class="comment">// Set abstract bit for old class files for backward compatibility</span></span><br><span class="line">    flags |= JVM_ACC_ABSTRACT;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">verify_legal_class_modifiers</span>(flags, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line">  access_flags.<span class="built_in">set_flags</span>(flags);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This class and superclass</span></span><br><span class="line">  _this_class_index = cfs-&gt;<span class="built_in">get_u2_fast</span>();</span><br><span class="line">  <span class="built_in">check_property</span>(</span><br><span class="line">    <span class="built_in">valid_cp_range</span>(_this_class_index, cp_size) &amp;&amp;</span><br><span class="line">      cp-&gt;<span class="built_in">tag_at</span>(_this_class_index).<span class="built_in">is_unresolved_klass</span>(),</span><br><span class="line">    <span class="string">&quot;Invalid this class index %u in constant pool in class file %s&quot;</span>,</span><br><span class="line">    _this_class_index, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">  Symbol*  class_name  = cp-&gt;<span class="built_in">unresolved_klass_at</span>(_this_class_index);</span><br><span class="line">  <span class="built_in">assert</span>(class_name != <span class="literal">NULL</span>, <span class="string">&quot;class_name can&#x27;t be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// It&#x27;s important to set parsed_name *before* resolving the super class.</span></span><br><span class="line">  <span class="comment">// (it&#x27;s used for cleanup by the caller if parsing fails)</span></span><br><span class="line">  parsed_name = class_name;</span><br><span class="line">  <span class="comment">// parsed_name is returned and can be used if there&#x27;s an error, so add to</span></span><br><span class="line">  <span class="comment">// its reference count.  Caller will decrement the refcount.</span></span><br><span class="line">  parsed_name-&gt;<span class="built_in">increment_refcount</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update _class_name which could be null previously to be class_name</span></span><br><span class="line">  _class_name = class_name;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Don&#x27;t need to check whether this class name is legal or not.</span></span><br><span class="line">  <span class="comment">// It has been checked when constant pool is parsed.</span></span><br><span class="line">  <span class="comment">// However, make sure it is not an array type.</span></span><br><span class="line">  <span class="keyword">if</span> (_need_verify) &#123;</span><br><span class="line">    <span class="built_in">guarantee_property</span>(class_name-&gt;<span class="built_in">byte_at</span>(<span class="number">0</span>) != JVM_SIGNATURE_ARRAY,</span><br><span class="line">                       <span class="string">&quot;Bad class name in class file %s&quot;</span>,</span><br><span class="line">                       <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Klass* preserve_this_klass;   <span class="comment">// for storing result across HandleMark</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// release all handles when parsing is done</span></span><br><span class="line">  &#123; <span class="function">HandleMark <span class="title">hm</span><span class="params">(THREAD)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Checks if name in class file matches requested name</span></span><br><span class="line">    <span class="keyword">if</span> (name != <span class="literal">NULL</span> &amp;&amp; class_name != name) &#123;</span><br><span class="line">      <span class="function">ResourceMark <span class="title">rm</span><span class="params">(THREAD)</span></span>;</span><br><span class="line">      Exceptions::<span class="built_in">fthrow</span>(</span><br><span class="line">        THREAD_AND_LOCATION,</span><br><span class="line">        vmSymbols::<span class="built_in">java_lang_NoClassDefFoundError</span>(),</span><br><span class="line">        <span class="string">&quot;%s (wrong name: %s)&quot;</span>,</span><br><span class="line">        name-&gt;<span class="built_in">as_C_string</span>(),</span><br><span class="line">        class_name-&gt;<span class="built_in">as_C_string</span>()</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span> nullHandle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TraceClassLoadingPreorder) &#123;</span><br><span class="line">      tty-&gt;<span class="built_in">print</span>(<span class="string">&quot;[Loading %s&quot;</span>, (name != <span class="literal">NULL</span>) ? name-&gt;<span class="built_in">as_klass_external_name</span>() : <span class="string">&quot;NoName&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (cfs-&gt;<span class="built_in">source</span>() != <span class="literal">NULL</span>) tty-&gt;<span class="built_in">print</span>(<span class="string">&quot; from %s&quot;</span>, cfs-&gt;<span class="built_in">source</span>());</span><br><span class="line">      tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_CDS</span></span><br><span class="line">    <span class="keyword">if</span> (DumpLoadedClassList != <span class="literal">NULL</span> &amp;&amp; cfs-&gt;<span class="built_in">source</span>() != <span class="literal">NULL</span> &amp;&amp; classlist_file-&gt;<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">      <span class="comment">// Only dump the classes that can be stored into CDS archive</span></span><br><span class="line">      <span class="keyword">if</span> (SystemDictionaryShared::<span class="built_in">is_sharing_possible</span>(loader_data)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="literal">NULL</span>) &#123;</span><br><span class="line">          <span class="function">ResourceMark <span class="title">rm</span><span class="params">(THREAD)</span></span>;</span><br><span class="line">          classlist_file-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;%s&quot;</span>, name-&gt;<span class="built_in">as_C_string</span>());</span><br><span class="line">          classlist_file-&gt;<span class="built_in">flush</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    u2 super_class_index = cfs-&gt;<span class="built_in">get_u2_fast</span>();</span><br><span class="line">    instanceKlassHandle super_klass = <span class="built_in">parse_super_class</span>(super_class_index,</span><br><span class="line">                                                        CHECK_NULL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Interfaces</span></span><br><span class="line">    u2 itfs_len = cfs-&gt;<span class="built_in">get_u2_fast</span>();</span><br><span class="line">    Array&lt;Klass*&gt;* local_interfaces =</span><br><span class="line">      <span class="built_in">parse_interfaces</span>(itfs_len, protection_domain, _class_name,</span><br><span class="line">                       &amp;has_default_methods, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    u2 java_fields_count = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Fields (offsets are filled in later)</span></span><br><span class="line">    FieldAllocationCount fac;</span><br><span class="line">    Array&lt;u2&gt;* fields = <span class="built_in">parse_fields</span>(class_name,</span><br><span class="line">                                     access_flags.<span class="built_in">is_interface</span>(),</span><br><span class="line">                                     &amp;fac, &amp;java_fields_count,</span><br><span class="line">                                     <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line">    <span class="comment">// Methods</span></span><br><span class="line">    <span class="keyword">bool</span> has_final_method = <span class="literal">false</span>;</span><br><span class="line">    AccessFlags promoted_flags;</span><br><span class="line">    promoted_flags.<span class="built_in">set_flags</span>(<span class="number">0</span>);</span><br><span class="line">    Array&lt;Method*&gt;* methods = <span class="built_in">parse_methods</span>(access_flags.<span class="built_in">is_interface</span>(),</span><br><span class="line">                                            &amp;promoted_flags,</span><br><span class="line">                                            &amp;has_final_method,</span><br><span class="line">                                            &amp;declares_default_methods,</span><br><span class="line">                                            <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line">    <span class="keyword">if</span> (declares_default_methods) &#123;</span><br><span class="line">      has_default_methods = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Additional attributes</span></span><br><span class="line">    ClassAnnotationCollector parsed_annotations;</span><br><span class="line">    <span class="built_in">parse_classfile_attributes</span>(&amp;parsed_annotations, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Finalize the Annotations metadata object,</span></span><br><span class="line">    <span class="comment">// now that all annotation arrays have been created.</span></span><br><span class="line">    <span class="built_in">create_combined_annotations</span>(<span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure this is the end of class file stream</span></span><br><span class="line">    <span class="built_in">guarantee_property</span>(cfs-&gt;<span class="built_in">at_eos</span>(), <span class="string">&quot;Extra bytes at the end of class file %s&quot;</span>, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_class_name == vmSymbols::<span class="built_in">java_lang_Object</span>()) &#123;</span><br><span class="line">      <span class="built_in">check_property</span>(_local_interfaces == Universe::<span class="built_in">the_empty_klass_array</span>(),</span><br><span class="line">                     <span class="string">&quot;java.lang.Object cannot implement an interface in class file %s&quot;</span>,</span><br><span class="line">                     <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// We check super class after class file is parsed and format is checked</span></span><br><span class="line">    <span class="keyword">if</span> (super_class_index &gt; <span class="number">0</span> &amp;&amp; super_klass.<span class="built_in">is_null</span>()) &#123;</span><br><span class="line">      Symbol*  sk  = cp-&gt;<span class="built_in">klass_name_at</span>(super_class_index);</span><br><span class="line">      <span class="keyword">if</span> (access_flags.<span class="built_in">is_interface</span>()) &#123;</span><br><span class="line">        <span class="comment">// Before attempting to resolve the superclass, check for class format</span></span><br><span class="line">        <span class="comment">// errors not checked yet.</span></span><br><span class="line">        <span class="built_in">guarantee_property</span>(sk == vmSymbols::<span class="built_in">java_lang_Object</span>(),</span><br><span class="line">                           <span class="string">&quot;Interfaces must have java.lang.Object as superclass in class file %s&quot;</span>,</span><br><span class="line">                           <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line">      &#125;</span><br><span class="line">      Klass* k = SystemDictionary::<span class="built_in">resolve_super_or_fail</span>(class_name, sk,</span><br><span class="line">                                                         class_loader,</span><br><span class="line">                                                         protection_domain,</span><br><span class="line">                                                         <span class="literal">true</span>,</span><br><span class="line">                                                         <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">      <span class="function">KlassHandle <span class="title">kh</span> <span class="params">(THREAD, k)</span></span>;</span><br><span class="line">      super_klass = <span class="built_in">instanceKlassHandle</span>(THREAD, <span class="built_in">kh</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (super_klass.<span class="built_in">not_null</span>()) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (super_klass-&gt;<span class="built_in">has_default_methods</span>()) &#123;</span><br><span class="line">        has_default_methods = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (super_klass-&gt;<span class="built_in">is_interface</span>()) &#123;</span><br><span class="line">        <span class="function">ResourceMark <span class="title">rm</span><span class="params">(THREAD)</span></span>;</span><br><span class="line">        Exceptions::<span class="built_in">fthrow</span>(</span><br><span class="line">          THREAD_AND_LOCATION,</span><br><span class="line">          vmSymbols::<span class="built_in">java_lang_IncompatibleClassChangeError</span>(),</span><br><span class="line">          <span class="string">&quot;class %s has interface %s as super class&quot;</span>,</span><br><span class="line">          class_name-&gt;<span class="built_in">as_klass_external_name</span>(),</span><br><span class="line">          super_klass-&gt;<span class="built_in">external_name</span>()</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> nullHandle;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Make sure super class is not final</span></span><br><span class="line">      <span class="keyword">if</span> (super_klass-&gt;<span class="built_in">is_final</span>()) &#123;</span><br><span class="line">        <span class="built_in">THROW_MSG_</span>(vmSymbols::<span class="built_in">java_lang_VerifyError</span>(), <span class="string">&quot;Cannot inherit from final class&quot;</span>, nullHandle);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// save super klass for error handling.</span></span><br><span class="line">    _super_klass = super_klass;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Compute the transitive list of all unique interfaces implemented by this class</span></span><br><span class="line">    _transitive_interfaces =</span><br><span class="line">          <span class="built_in">compute_transitive_interfaces</span>(super_klass, local_interfaces, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sort methods</span></span><br><span class="line">    intArray* method_ordering = <span class="built_in">sort_methods</span>(methods);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// promote flags from parse_methods() to the klass&#x27; flags</span></span><br><span class="line">    access_flags.<span class="built_in">add_promoted_flags</span>(promoted_flags.<span class="built_in">as_int</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Size of Java vtable (in words)</span></span><br><span class="line">    <span class="keyword">int</span> vtable_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> itable_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> num_miranda_methods = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">GrowableArray&lt;Method*&gt; <span class="title">all_mirandas</span><span class="params">(<span class="number">20</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    klassVtable::<span class="built_in">compute_vtable_size_and_num_mirandas</span>(</span><br><span class="line">        &amp;vtable_size, &amp;num_miranda_methods, &amp;all_mirandas, <span class="built_in">super_klass</span>(), methods,</span><br><span class="line">        access_flags, class_loader, class_name, local_interfaces,</span><br><span class="line">                                                      <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Size of Java itable (in words)</span></span><br><span class="line">    itable_size = access_flags.<span class="built_in">is_interface</span>() ? <span class="number">0</span> : klassItable::<span class="built_in">compute_itable_size</span>(_transitive_interfaces);</span><br><span class="line"></span><br><span class="line">    FieldLayoutInfo info;</span><br><span class="line">    <span class="built_in">layout_fields</span>(class_loader, &amp;fac, &amp;parsed_annotations, &amp;info, CHECK_NULL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> total_oop_map_size2 =</span><br><span class="line">          InstanceKlass::<span class="built_in">nonstatic_oop_map_size</span>(info.total_oop_map_count);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Compute reference type</span></span><br><span class="line">    ReferenceType rt;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">super_klass</span>() == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      rt = REF_NONE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      rt = super_klass-&gt;<span class="built_in">reference_type</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We can now create the basic Klass* for this klass</span></span><br><span class="line">    _klass = InstanceKlass::<span class="built_in">allocate_instance_klass</span>(loader_data,</span><br><span class="line">                                                    vtable_size,</span><br><span class="line">                                                    itable_size,</span><br><span class="line">                                                    info.static_field_size,</span><br><span class="line">                                                    total_oop_map_size2,</span><br><span class="line">                                                    rt,</span><br><span class="line">                                                    access_flags,</span><br><span class="line">                                                    name,</span><br><span class="line">                                                    <span class="built_in">super_klass</span>(),</span><br><span class="line">                                                    !host_klass.<span class="built_in">is_null</span>(),</span><br><span class="line">                                                    <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line">    <span class="function">instanceKlassHandle <span class="title">this_klass</span> <span class="params">(THREAD, _klass)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert</span>(this_klass-&gt;<span class="built_in">static_field_size</span>() == info.static_field_size, <span class="string">&quot;sanity&quot;</span>);</span><br><span class="line">    <span class="built_in">assert</span>(this_klass-&gt;<span class="built_in">nonstatic_oop_map_count</span>() == info.total_oop_map_count,</span><br><span class="line">           <span class="string">&quot;sanity&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fill in information already parsed</span></span><br><span class="line">    this_klass-&gt;<span class="built_in">set_should_verify_class</span>(verify);</span><br><span class="line">    jint lh = Klass::<span class="built_in">instance_layout_helper</span>(info.instance_size, <span class="literal">false</span>);</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_layout_helper</span>(lh);</span><br><span class="line">    <span class="built_in">assert</span>(this_klass-&gt;<span class="built_in">oop_is_instance</span>(), <span class="string">&quot;layout is correct&quot;</span>);</span><br><span class="line">    <span class="built_in">assert</span>(this_klass-&gt;<span class="built_in">size_helper</span>() == info.instance_size, <span class="string">&quot;correct size_helper&quot;</span>);</span><br><span class="line">    <span class="comment">// Not yet: supers are done below to support the new subtype-checking fields</span></span><br><span class="line">    <span class="comment">//this_klass-&gt;set_super(super_klass());</span></span><br><span class="line">    this_klass-&gt;<span class="built_in">set_class_loader_data</span>(loader_data);</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_nonstatic_field_size</span>(info.nonstatic_field_size);</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_has_nonstatic_fields</span>(info.has_nonstatic_fields);</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_static_oop_field_count</span>(fac.count[STATIC_OOP]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">apply_parsed_class_metadata</span>(this_klass, java_fields_count, CHECK_NULL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (has_final_method) &#123;</span><br><span class="line">      this_klass-&gt;<span class="built_in">set_has_final_method</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    this_klass-&gt;<span class="built_in">copy_method_ordering</span>(method_ordering, CHECK_NULL);</span><br><span class="line">    <span class="comment">// The InstanceKlass::_methods_jmethod_ids cache</span></span><br><span class="line">    <span class="comment">// is managed on the assumption that the initial cache</span></span><br><span class="line">    <span class="comment">// size is equal to the number of methods in the class. If</span></span><br><span class="line">    <span class="comment">// that changes, then InstanceKlass::idnum_can_increment()</span></span><br><span class="line">    <span class="comment">// has to be changed accordingly.</span></span><br><span class="line">    this_klass-&gt;<span class="built_in">set_initial_method_idnum</span>(methods-&gt;<span class="built_in">length</span>());</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_name</span>(cp-&gt;<span class="built_in">klass_name_at</span>(_this_class_index));</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">is_anonymous</span>())  <span class="comment">// I am well known to myself</span></span><br><span class="line">      cp-&gt;<span class="built_in">klass_at_put</span>(_this_class_index, <span class="built_in">this_klass</span>()); <span class="comment">// eagerly resolve</span></span><br><span class="line"></span><br><span class="line">    this_klass-&gt;<span class="built_in">set_minor_version</span>(minor_version);</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_major_version</span>(major_version);</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_has_default_methods</span>(has_default_methods);</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_declares_default_methods</span>(declares_default_methods);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!host_klass.<span class="built_in">is_null</span>()) &#123;</span><br><span class="line">      <span class="built_in">assert</span> (this_klass-&gt;<span class="built_in">is_anonymous</span>(), <span class="string">&quot;should be the same&quot;</span>);</span><br><span class="line">      this_klass-&gt;<span class="built_in">set_host_klass</span>(<span class="built_in">host_klass</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set up Method*::intrinsic_id as soon as we know the names of methods.</span></span><br><span class="line">    <span class="comment">// (We used to do this lazily, but now we query it in Rewriter,</span></span><br><span class="line">    <span class="comment">// which is eagerly done for every method, so we might as well do it now,</span></span><br><span class="line">    <span class="comment">// when everything is fresh in memory.)</span></span><br><span class="line">    <span class="keyword">if</span> (Method::<span class="built_in">klass_id_for_intrinsics</span>(<span class="built_in">this_klass</span>()) != vmSymbols::NO_SID) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; methods-&gt;<span class="built_in">length</span>(); j++) &#123;</span><br><span class="line">        methods-&gt;<span class="built_in">at</span>(j)-&gt;<span class="built_in">init_intrinsic_id</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cached_class_file != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="comment">// JVMTI: we have an InstanceKlass now, tell it about the cached bytes</span></span><br><span class="line">      this_klass-&gt;<span class="built_in">set_cached_class_file</span>(cached_class_file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fill in field values obtained by parse_classfile_attributes</span></span><br><span class="line">    <span class="keyword">if</span> (parsed_annotations.<span class="built_in">has_any_annotations</span>())</span><br><span class="line">      parsed_annotations.<span class="built_in">apply_to</span>(this_klass);</span><br><span class="line">    <span class="built_in">apply_parsed_class_attributes</span>(this_klass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Miranda methods</span></span><br><span class="line">    <span class="keyword">if</span> ((num_miranda_methods &gt; <span class="number">0</span>) ||</span><br><span class="line">        <span class="comment">// if this class introduced new miranda methods or</span></span><br><span class="line">        (super_klass.<span class="built_in">not_null</span>() &amp;&amp; (super_klass-&gt;<span class="built_in">has_miranda_methods</span>()))</span><br><span class="line">        <span class="comment">// super class exists and this class inherited miranda methods</span></span><br><span class="line">        ) &#123;</span><br><span class="line">      this_klass-&gt;<span class="built_in">set_has_miranda_methods</span>(); <span class="comment">// then set a flag</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fill in information needed to compute superclasses.</span></span><br><span class="line">    this_klass-&gt;<span class="built_in">initialize_supers</span>(<span class="built_in">super_klass</span>(), <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize itable offset tables</span></span><br><span class="line">    klassItable::<span class="built_in">setup_itable_offset_table</span>(this_klass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Compute transitive closure of interfaces this class implements</span></span><br><span class="line">    <span class="comment">// Do final class setup</span></span><br><span class="line">    <span class="built_in">fill_oop_maps</span>(this_klass, info.nonstatic_oop_map_count, info.nonstatic_oop_offsets, info.nonstatic_oop_counts);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fill in has_finalizer, has_vanilla_constructor, and layout_helper</span></span><br><span class="line">    <span class="built_in">set_precomputed_flags</span>(this_klass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reinitialize modifiers, using the InnerClasses attribute</span></span><br><span class="line">    <span class="keyword">int</span> computed_modifiers = this_klass-&gt;<span class="built_in">compute_modifier_flags</span>(<span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line">    this_klass-&gt;<span class="built_in">set_modifier_flags</span>(computed_modifiers);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check if this class can access its super class</span></span><br><span class="line">    <span class="built_in">check_super_class_access</span>(this_klass, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check if this class can access its superinterfaces</span></span><br><span class="line">    <span class="built_in">check_super_interface_access</span>(this_klass, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check if this class overrides any final method</span></span><br><span class="line">    <span class="built_in">check_final_method_override</span>(this_klass, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check that if this class is an interface then it doesn&#x27;t have static methods</span></span><br><span class="line">    <span class="keyword">if</span> (this_klass-&gt;<span class="built_in">is_interface</span>()) &#123;</span><br><span class="line">      <span class="comment">/* An interface in a JAVA 8 classfile can be static */</span></span><br><span class="line">      <span class="keyword">if</span> (_major_version &lt; JAVA_8_VERSION) &#123;</span><br><span class="line">        <span class="built_in">check_illegal_static_method</span>(this_klass, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate mirror and initialize static fields</span></span><br><span class="line">    java_lang_Class::<span class="built_in">create_mirror</span>(this_klass, class_loader, protection_domain,</span><br><span class="line">                                   <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate any default methods - default methods are interface methods</span></span><br><span class="line">    <span class="comment">// that have a default implementation.  This is new with Lambda project.</span></span><br><span class="line">    <span class="keyword">if</span> (has_default_methods ) &#123;</span><br><span class="line">      DefaultMethods::<span class="built_in">generate_default_methods</span>(</span><br><span class="line">          <span class="built_in">this_klass</span>(), &amp;all_mirandas, <span class="built_in">CHECK_</span>(nullHandle));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ClassLoadingService::<span class="built_in">notify_class_loaded</span>(InstanceKlass::<span class="built_in">cast</span>(<span class="built_in">this_klass</span>()),</span><br><span class="line">                                             <span class="literal">false</span> <span class="comment">/* not shared class */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TraceClassLoading) &#123;</span><br><span class="line">      ResourceMark rm;</span><br><span class="line">      <span class="comment">// print in a single call to reduce interleaving of output</span></span><br><span class="line">      <span class="keyword">if</span> (cfs-&gt;<span class="built_in">source</span>() != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        tty-&gt;<span class="built_in">print</span>(<span class="string">&quot;[Loaded %s from %s]\n&quot;</span>, this_klass-&gt;<span class="built_in">external_name</span>(),</span><br><span class="line">                   cfs-&gt;<span class="built_in">source</span>());</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (class_loader.<span class="built_in">is_null</span>()) &#123;</span><br><span class="line">        Klass* caller =</span><br><span class="line">            THREAD-&gt;<span class="built_in">is_Java_thread</span>()</span><br><span class="line">                ? ((JavaThread*)THREAD)-&gt;<span class="built_in">security_get_caller_class</span>(<span class="number">1</span>)</span><br><span class="line">                : <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">// caller can be NULL, for example, during a JVMTI VM_Init hook</span></span><br><span class="line">        <span class="keyword">if</span> (caller != <span class="literal">NULL</span>) &#123;</span><br><span class="line">          tty-&gt;<span class="built_in">print</span>(<span class="string">&quot;[Loaded %s by instance of %s]\n&quot;</span>,</span><br><span class="line">                     this_klass-&gt;<span class="built_in">external_name</span>(),</span><br><span class="line">                     InstanceKlass::<span class="built_in">cast</span>(caller)-&gt;<span class="built_in">external_name</span>());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          tty-&gt;<span class="built_in">print</span>(<span class="string">&quot;[Loaded %s]\n&quot;</span>, this_klass-&gt;<span class="built_in">external_name</span>());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        tty-&gt;<span class="built_in">print</span>(<span class="string">&quot;[Loaded %s from %s]\n&quot;</span>, this_klass-&gt;<span class="built_in">external_name</span>(),</span><br><span class="line">                   InstanceKlass::<span class="built_in">cast</span>(class_loader-&gt;<span class="built_in">klass</span>())-&gt;<span class="built_in">external_name</span>());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TraceClassResolution) &#123;</span><br><span class="line">      ResourceMark rm;</span><br><span class="line">      <span class="comment">// print out the superclass.</span></span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">char</span> * from = <span class="built_in">this_klass</span>()-&gt;<span class="built_in">external_name</span>();</span><br><span class="line">      <span class="keyword">if</span> (this_klass-&gt;<span class="built_in">java_super</span>() != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        tty-&gt;<span class="built_in">print</span>(<span class="string">&quot;RESOLVE %s %s (super)\n&quot;</span>, from, InstanceKlass::<span class="built_in">cast</span>(this_klass-&gt;<span class="built_in">java_super</span>())-&gt;<span class="built_in">external_name</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// print out each of the interface classes referred to by this class.</span></span><br><span class="line">      Array&lt;Klass*&gt;* local_interfaces = this_klass-&gt;<span class="built_in">local_interfaces</span>();</span><br><span class="line">      <span class="keyword">if</span> (local_interfaces != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> length = local_interfaces-&gt;<span class="built_in">length</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">          Klass* k = local_interfaces-&gt;<span class="built_in">at</span>(i);</span><br><span class="line">          InstanceKlass* to_class = InstanceKlass::<span class="built_in">cast</span>(k);</span><br><span class="line">          <span class="keyword">const</span> <span class="keyword">char</span> * to = to_class-&gt;<span class="built_in">external_name</span>();</span><br><span class="line">          tty-&gt;<span class="built_in">print</span>(<span class="string">&quot;RESOLVE %s %s (interface)\n&quot;</span>, from, to);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// preserve result across HandleMark</span></span><br><span class="line">    preserve_this_klass = <span class="built_in">this_klass</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">JFR_ONLY</span>(<span class="built_in">INIT_ID</span>(preserve_this_klass);)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create new handle outside HandleMark (might be needed for</span></span><br><span class="line">  <span class="comment">// Extended Class Redefinition)</span></span><br><span class="line">  <span class="function">instanceKlassHandle <span class="title">this_klass</span> <span class="params">(THREAD, preserve_this_klass)</span></span>;</span><br><span class="line">  <span class="built_in">debug_only</span>(this_klass-&gt;<span class="built_in">verify</span>();)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clear class if no error has occurred so destructor doesn&#x27;t deallocate it</span></span><br><span class="line">  _klass = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> this_klass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details>

<br/>

<p>而 <code>parseClassFile()</code> 函数就是我们类加载中，解析 class 字节流，生成 <code>instanceKlass</code> C++ 对等对象这部分的逻辑和流程，可参考前面的文章。</p>
<h2 id="Java-语言定义的类加载器"><a href="#Java-语言定义的类加载器" class="headerlink" title="Java 语言定义的类加载器"></a>Java 语言定义的类加载器</h2><p>Java语言定义的类加载器就是 JDK 核心类库中的类：<code>java.lang.ClassLoader</code>，jdk8 中的加载器类的关系如下图：<br><img src="/2021-12-JVM%E7%B3%BB%E5%88%97-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/jdk_class_loader.png" alt="JDK加载器类之间的关系"></p>
<p><code>AppClassLoader</code> 和 <code>ExtClassLoader</code> 都被组合在 <code>Launcher</code> 中。扩展类加载器和系统类加载器都最终依赖于 <code>ClassLoader</code> 类的 <code>defineClass</code> 的 <code>native</code> 方法，才能完成类加载。</p>
<p>3种类型的类加载器之间的关系：<br><img src="/2021-12-JVM%E7%B3%BB%E5%88%97-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/java_class_loader.png" alt="类加载器"></p>
<p>各种类加载器之间的关系并非面向对象的特性 <strong>“继承”</strong> 的关系，引导类加载器是用 C++ 写的，java 类想去继承也没有办法。上面的 JDK 类加载器也是被组合在 <code>Launcher</code> 类中，都是继承的 <code>URLClassLoader</code> 类。</p>
<p>所以这里可以看出，上面的 3 种类型的类加载器之间并没有面向对象中 “继承” 关系。</p>
<h2 id="双亲委派机制"><a href="#双亲委派机制" class="headerlink" title="双亲委派机制"></a>双亲委派机制</h2><p>对于java应用来说，会用 <code>AppClassLoader</code> 类加载器去加载，先来看下 JDK 类加载方法调用链：</p>
<p><img src="/2021-12-JVM%E7%B3%BB%E5%88%97-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/jdk_class_loader_method_calling.png" alt="类加载方法调用链"></p>
<p>上面的调用链中，最终还是会调用类 <code>ClassLoader</code> 中的 <code>native</code> 的方法去加载。比较重要的两个方法，一个是 <code>loadClass()</code> 和 <code>defineClass()</code>，着重来看一下这两个方法，首先看 <code>loadClass</code> 方法，这个方法就是<strong>双亲委托</strong>加载机制的核心，方法源码：</p>
<figure class="highlight java"><figcaption><span>ClassLoader</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">     ......</span><br><span class="line">     </span><br><span class="line">    <span class="comment">// The parent class loader for delegation</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader parent;</span><br><span class="line">     ......</span><br><span class="line">	<span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">		<span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">			<span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">			Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">			<span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">						c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						c = findBootstrapClassOrNull(name);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">					<span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">					<span class="comment">// from the non-null parent class loader</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">					<span class="comment">// to find the class.</span></span><br><span class="line">					<span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">					c = findClass(name);</span><br><span class="line"></span><br><span class="line">					<span class="comment">// this is the defining class loader; record the stats</span></span><br><span class="line">					sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">					sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">					sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">				resolveClass(c);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> c;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道，系统类加载器的父加载器是扩展类加载器，扩展类加载器的父类加载器是引导类加载器。java 应用类在系统类加载器（<code>AppClassLoader</code>）加载后，会进入到 <code>ClassLoader</code> 中的 <code>loadClasss()</code> 方法，在方法中：</p>
<ol>
<li>首先判断有没有加载过该类</li>
<li>在<code>AppClassLoader</code>加载时，它的代理类加载器即 <code>parent</code> 是 <code>ExtClassLoader</code>，<code>parent</code> 不为空，继续嵌套调用 <code>loaderClass</code> 方法，这时候的 <code>this</code> 指向的是 <code>ExtClassLoader</code>，它的代理类是 C++ 引导类，所以在 java 里面是 <code>null</code>，就会进入方法 <code>findBootstrapClassOrNull</code>，这个方法调用的 <code>native</code> 的引导类加载的。</li>
<li>在上面的做操作后，如果还是没有找到该类的话，就会调用方法 <code>findClass</code>，这个方法在 <code>ClassLoader</code> 类中是留给子类实现的，在 <code>URLClassLoader</code> 中实现了该方法，最终还是会调用 <code>ClassLoader</code> 中的 <code>defineClass</code> 方法，而 <code>ClassLoader</code> 中的 <code>defineClass</code> 方法最后调用的是 <code>native</code> 系列的 <code>defineClass*</code> 方法，如下：<figure class="highlight java"><figcaption><span>native 系列的 defineClass 方法</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">native</span> Class&lt;?&gt; defineClass0(String name, <span class="keyword">byte</span>[] b, <span class="keyword">int</span> off, <span class="keyword">int</span> len, ProtectionDomain pd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">native</span> Class&lt;?&gt; defineClass1(String name, <span class="keyword">byte</span>[] b, <span class="keyword">int</span> off, <span class="keyword">int</span> len, ProtectionDomain pd, String source);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">native</span> Class&lt;?&gt; defineClass2(String name, java.nio.ByteBuffer b, <span class="keyword">int</span> off, <span class="keyword">int</span> len, ProtectionDomain pd,</span><br><span class="line">		String source);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>所以在 JDK 中的类加载器，先找App类加载器加载，然后系统类加载器找扩展类加载器加载，扩展类加载器找引导类加载器加载，如果Ext加载器加载和Bootstrap类加载器都没有找到该类的话，那么App类加载器完成该类的加载，一级一级的往上委托，如果都不行，就自己加载，这样就保证了所有的类都能保证同一个类加载器。这就是双亲委托机制。</p>
<p>从上面的代码可以看到，如果想要自定义一个类加载器，并且打破双亲委派机制，那么需要重写类 <code>ClassLoader</code> 中 <code>findClass</code> 方法。可以来看一个例子：<br>首先定义一个 <code>Hello.java</code> 类，代码：</p>
<figure class="highlight java"><figcaption><span>Hello.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.caolizhi.example.jvm.classloader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">helloClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello, class loader: &quot;</span> + <span class="keyword">this</span>.getClass().getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再定义一个类加载器，继承 <code>ClassLoader</code> 类，并且重写方法 <code>findClass</code>。如下：</p>
<figure class="highlight java"><figcaption><span>CLZClassLoader.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CLZClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        File f = <span class="keyword">new</span> File(<span class="string">&quot;E:/Workspaces/Git/caolizhi/jvm/target/classes/&quot;</span>, name.replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;/&quot;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">        Class&lt;?&gt; clazz = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(f);</span><br><span class="line">            ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">int</span> b;</span><br><span class="line">            <span class="keyword">while</span> ((b = fileInputStream.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                byteArrayOutputStream.write(b);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">            byteArrayOutputStream.close();</span><br><span class="line">            fileInputStream.close();</span><br><span class="line">            clazz = defineClass(name, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CLZClassLoader clzClassLoader = <span class="keyword">new</span> CLZClassLoader();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;系统类加载器：&quot;</span>);</span><br><span class="line">            Class&lt;?&gt; clazz1 = clzClassLoader.loadClass(<span class="string">&quot;top.caolizhi.example.jvm.classloader.Hello&quot;</span>);</span><br><span class="line">            Hello hello = (Hello) clazz1.newInstance();</span><br><span class="line">            hello.helloClassLoader();</span><br><span class="line">            System.out.println(<span class="string">&quot;=====================================================================&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;自定义类加载器：&quot;</span>);</span><br><span class="line">            Class&lt;?&gt; clazz = clzClassLoader.findClass(<span class="string">&quot;top.caolizhi.example.jvm.classloader.Hello&quot;</span>);</span><br><span class="line">            Object o = clazz.getDeclaredConstructor().newInstance();</span><br><span class="line">            <span class="comment">// Hello o = (Hello) clazz.getDeclaredConstructor().newInstance(); // 强转就会报错，因为不是同一个类加载器加载的，JVM 认为不是同一个类。</span></span><br><span class="line">            <span class="comment">// o.helloClassLoader();</span></span><br><span class="line">            Method method = clazz.getDeclaredMethod(<span class="string">&quot;helloClassLoader&quot;</span>);</span><br><span class="line">            method.invoke(o,<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException | InvocationTargetException | NoSuchMethodException | IllegalAccessException | ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CLZClassLoader</code> 类 <code>main</code> 方法中，用 JDK 提供的方法 <code>loadClass</code> 和 自定义的 <code>findClass</code> 方法分别加载 <code>Hello</code> 类， <code>Hello</code> 类中的 <code>helloClassLoader()</code> 方法打印自己的类加载器信息。输出结果已经很明确，前者是双亲委托加载，后者并非如此。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">系统类加载器：</span><br><span class="line">hello, class loader: sun.misc.Launcher$AppClassLoader@18b4aac2</span><br><span class="line">=====================================================================</span><br><span class="line">自定义类加载器：</span><br><span class="line">hello, class loader: top.caolizhi.example.jvm.classloader.CLZClassLoader@2f0e140b</span><br></pre></td></tr></table></figure>

<p>另外不管是 JDK 的类加载器还是自定义的类加载器，最后都会调用方法 <code>defineClass</code> 方法，这个方法结构如下：</p>
<figure class="highlight java"><figcaption><span>defineClass 方法</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; defineClass(String name, <span class="keyword">byte</span>[] b, <span class="keyword">int</span> off, <span class="keyword">int</span> len,</span><br><span class="line">		ProtectionDomain protectionDomain)</span><br><span class="line">		<span class="keyword">throws</span> ClassFormatError</span><br><span class="line">	&#123;</span><br><span class="line">		protectionDomain = preDefineClass(name, protectionDomain);</span><br><span class="line">		String source = defineClassSourceLocation(protectionDomain);</span><br><span class="line">		Class&lt;?&gt; c = defineClass1(name, b, off, len, protectionDomain, source);</span><br><span class="line">		postDefineClass(c, protectionDomain);</span><br><span class="line">		<span class="keyword">return</span> c;</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里面有个方法 <code>preDefineClass</code> 值得注意，其方法内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Determine protection domain, and check that:</span></span><br><span class="line"><span class="comment">        - not define java.* class,</span></span><br><span class="line"><span class="comment">        - signer of this class matches signers for the rest of the classes in</span></span><br><span class="line"><span class="comment">          package.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> ProtectionDomain <span class="title">preDefineClass</span><span class="params">(String name,</span></span></span><br><span class="line"><span class="params"><span class="function">		ProtectionDomain pd)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!checkName(name))</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(<span class="string">&quot;IllegalName: &quot;</span> + name);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Note:  Checking logic in java.lang.invoke.MemberName.checkForTypeAlias</span></span><br><span class="line">		<span class="comment">// relies on the fact that spoofing is impossible if a class has a name</span></span><br><span class="line">		<span class="comment">// of the form &quot;java.*&quot;</span></span><br><span class="line">		<span class="keyword">if</span> ((name != <span class="keyword">null</span>) &amp;&amp; name.startsWith(<span class="string">&quot;java.&quot;</span>)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> SecurityException</span><br><span class="line">				(<span class="string">&quot;Prohibited package name: &quot;</span> +</span><br><span class="line">					name.substring(<span class="number">0</span>, name.lastIndexOf(<span class="string">&#x27;.&#x27;</span>)));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (pd == <span class="keyword">null</span>) &#123;</span><br><span class="line">			pd = defaultDomain;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (name != <span class="keyword">null</span>) checkCerts(name, pd.getCodeSource());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> pd;</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从它的方法体可以看到，如果加载的类的 <code>name</code> 是以 <code>java.</code> 前缀开头的，直接拒绝，抛出异常，而 <code>java.</code> 开头的类都是 JDK 的核心类，哈哈，机关在这里呢，所以无论如何，JDK 的核心类库，比如 <code>java.lang.Object</code> 都是有保护机制的，就算是自定义的类加载器也只能重写 <code>findClass</code> 方法，最底层的 <code>defineClass</code> 方法无可撼动。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li>《深入理解 Java 虚拟机（第3版）》 周志明著.</li>
<li>《揭秘 Java 虚拟机：JVM 设计原理与实现》 封亚飞著.</li>
</ol>
</div><div class="article-licensing box"><div class="licensing-title"><p>JVM系列-双亲委派模型</p><p><a href="https://caolizhi.top/2021-12-JVM系列-双亲委派模型/">https://caolizhi.top/2021-12-JVM系列-双亲委派模型/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>操先森</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-12-15</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-12-21</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/JVM/">JVM</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=6164f650ea6eca00151d8d08&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/images/wechat_pay.jpg" alt="微信"></span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/images/alipay.jpg" alt="支付宝"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021-12-JVM%E7%B3%BB%E5%88%97-%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">JVM系列 —— 运行时数据区</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021-12-%E6%89%8B%E6%8A%8A%E6%89%8B%E5%B8%A6%E4%BD%A0%E8%AF%BBclass%E6%96%87%E4%BB%B6%E5%AD%97%E8%8A%82%E7%A0%81/"><span class="level-item">手把手带你读class文件字节码</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "abef92d7403b0b81a83572dc401dec65",
            repo: "caolizhi.github.io",
            owner: "caolizhi",
            clientID: "a494d62f203aa8c7e2e2",
            clientSecret: "7114657b7a13cc18ec25989917c5d2de0de93f5c",
            admin: ["caolizhi"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/images/avatar.png" alt="操先森"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">操先森</p><p class="is-size-6 is-block">Java Engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>四川·成都</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">25</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">13</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/caolizhi" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/caolizhi"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#写在前面"><span class="level-left"><span class="level-item">1</span><span class="level-item">写在前面</span></span></a></li><li><a class="level is-mobile" href="#C-定义的引导类加载器"><span class="level-left"><span class="level-item">2</span><span class="level-item">C++ 定义的引导类加载器</span></span></a></li><li><a class="level is-mobile" href="#Java-语言定义的类加载器"><span class="level-left"><span class="level-item">3</span><span class="level-item">Java 语言定义的类加载器</span></span></a></li><li><a class="level is-mobile" href="#双亲委派机制"><span class="level-left"><span class="level-item">4</span><span class="level-item">双亲委派机制</span></span></a></li><li><a class="level is-mobile" href="#参考"><span class="level-left"><span class="level-item">5</span><span class="level-item">参考</span></span></a></li></ul></div></div><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">12</span></span></a><ul><li><a class="level is-mobile" href="/categories/Java/JVM/"><span class="level-start"><span class="level-item">JVM</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/"><span class="level-start"><span class="level-item">内存模型</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="level-start"><span class="level-item">多线程</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"><span class="level-start"><span class="level-item">云原生</span></span><span class="level-end"><span class="level-item tag">4</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/K8S/"><span class="level-start"><span class="level-item">K8S</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/"><span class="level-start"><span class="level-item">响应式编程</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="level-start"><span class="level-item">数据库</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/"><span class="level-start"><span class="level-item">MongoDB</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/"><span class="level-start"><span class="level-item">MySQL</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"><span class="level-start"><span class="level-item">网络编程</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-01T08:31:25.000Z">2022-01-01</time></p><p class="title"><a href="/2022-01-JVM%E7%B3%BB%E5%88%97-%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%A7%E5%B0%8F/">JVM系列 —— 对象的大小</a></p><p class="categories"><a href="/categories/Java/">Java</a> / <a href="/categories/Java/JVM/">JVM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-23T02:34:08.000Z">2021-12-23</time></p><p class="title"><a href="/2021-12-JVM%E7%B3%BB%E5%88%97-%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA/">JVM系列 —— 运行时数据区</a></p><p class="categories"><a href="/categories/Java/">Java</a> / <a href="/categories/Java/JVM/">JVM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-15T06:40:59.000Z">2021-12-15</time></p><p class="title"><a href="/2021-12-JVM%E7%B3%BB%E5%88%97-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/">JVM系列-双亲委派模型</a></p><p class="categories"><a href="/categories/Java/">Java</a> / <a href="/categories/Java/JVM/">JVM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-09T01:12:07.000Z">2021-12-09</time></p><p class="title"><a href="/2021-12-%E6%89%8B%E6%8A%8A%E6%89%8B%E5%B8%A6%E4%BD%A0%E8%AF%BBclass%E6%96%87%E4%BB%B6%E5%AD%97%E8%8A%82%E7%A0%81/">手把手带你读class文件字节码</a></p><p class="categories"><a href="/categories/Java/">Java</a> / <a href="/categories/Java/JVM/">JVM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-02T03:08:13.000Z">2021-12-02</time></p><p class="title"><a href="/2021-12-JVM%E7%B3%BB%E5%88%97-%E9%93%BE%E6%8E%A5%E5%92%8C%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96/">JVM系列 —— 类的生命周期之链接和类初始化</a></p><p class="categories"><a href="/categories/Java/">Java</a> / <a href="/categories/Java/JVM/">JVM</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">十二月 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/AQS/"><span class="tag">AQS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CAS/"><span class="tag">CAS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/I-O/"><span class="tag">I/O</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JUC/"><span class="tag">JUC</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JVM/"><span class="tag">JVM</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/K8S/"><span class="tag">K8S</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MongoDB/"><span class="tag">MongoDB</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/reactive/"><span class="tag">reactive</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/"><span class="tag">线程池</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/"><span class="tag">虚拟机</span><span class="tag">3</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/logo.svg" alt="操先森的博客" height="28"></a><p class="is-size-7"><span>&copy; 2022 操先森</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/caolizhi"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>